<template>
  <div class="add-content-container" v-if="declartionInformation">
    <div class="add-content">
      <div class="back-normal" @click="cancel"><img src="@/assets/images/arrow-left.png" />‰ø°ÊÅØÂ°´Êä•</div>
      <div class="project-basic-info">
        <h3 class="section-title">È°πÁõÆÂü∫Á°Ä‰ø°ÊÅØ</h3>
        <el-form ref="basicFormRef" :model="form" label-width="240px" :rules="rules" status-icon>
          <!-- Âü∫Á°Ä‰ø°ÊÅØÂ≠óÊÆµ‰∏çÂèò -->
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Âª∫ËÆæÊ¥ªÂä®ÔºàÂª∫ËÆæÈ°πÁõÆÔºâÂêçÁß∞" prop="projectName">
                <el-input v-model="form.projectName" placeholder="ËØ∑ËæìÂÖ•Âª∫ËÆæÈ°πÁõÆÂêçÁß∞" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="È°πÁõÆ‰ª£Á†Å" prop="projectCode">
                <el-input v-model="form.projectCode" placeholder="ËØ∑ËæìÂÖ•È°πÁõÆ‰ª£Á†Å" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÊâÄÂ±ûË°åÊîøÂå∫Âàí" prop="administrativeRegion">
                <el-input v-model="form.administrativeRegion" placeholder="ËØ∑ËæìÂÖ•ÊâÄÂ±ûË°åÊîøÂå∫Âàí" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Ê∂âÂèäÈ£éÊôØÂêçËÉúÂå∫ÂêçÁß∞" prop="scenicArea">
                <el-input v-model="form.scenicArea" placeholder="ËØ∑ËæìÂÖ•Ê∂âÂèäÈ£éÊôØÂêçËÉúÂå∫ÂêçÁß∞" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Âçï‰ΩçÂª∫ËÆæ/‰∏™‰∫∫Âª∫ËÆæ" prop="applicantType">
                <el-radio-group v-model="form.applicantType">
                  <el-radio label="Âçï‰Ωç">Âçï‰Ωç</el-radio>
                  <el-radio label="‰∏™‰∫∫">‰∏™‰∫∫</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="‰∏ÄËà¨/ÈáçÁÇπÈ°πÁõÆ" prop="majorFlag">
                <el-radio-group v-model="form.majorFlag" disabled>
                  <el-radio :label="false">‰∏ÄËà¨È°πÁõÆ</el-radio>
                  <el-radio :label="true">ÈáçÂ§ßÈ°πÁõÆ</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>

      <!-- Âª∫ËÆæ‰ø°ÊÅØ -->
      <div class="project-documents">
        <div class="section-header">
          <h3 class="section-title">Âª∫ËÆæ‰ø°ÊÅØ</h3>
          <el-button type="primary" @click="handleModelPreview" class="modelPreview">
            <img class="imgModel" src="@/assets/images/model.png" />‰∏âÁª¥Âú∫ÊôØÊïàÊûúÈ¢ÑËßà
          </el-button>
        </div>
        <el-form ref="infoFormRef" :model="form" label-width="240px" :rules="rules" status-icon>
          <!-- Âª∫ËÆæ‰ø°ÊÅØÂ≠óÊÆµ‰∏çÂèò -->
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Âª∫ËÆæÂçï‰ΩçÂêçÁß∞" prop="constructionUnit">
                <el-input v-model="form.constructionUnit" placeholder="ËØ∑ËæìÂÖ•Âª∫ËÆæÂçï‰ΩçÂêçÁß∞" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÁªÑÁªáÊú∫ÊûÑ‰ª£Á†Å" prop="organizationCode">
                <el-input v-model="form.organizationCode" placeholder="ËØ∑ËæìÂÖ•ÁªÑÁªáÊú∫ÊûÑ‰ª£Á†Å" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÁªèÂäû‰∫∫" prop="contactPerson">
                <el-input v-model="form.contactPerson" placeholder="ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÁªèÂäû‰∫∫ËÅîÁ≥ªÊñπÂºè" prop="contactPhone">
                <el-input v-model="form.contactPhone" placeholder="ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫ËÅîÁ≥ªÊñπÂºè" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="‰øùÊä§Âå∫Á≠âÁ∫ß" prop="protectionLevel">
                <el-select v-model="form.protectionLevel" placeholder="ËØ∑ÈÄâÊã©Ê∂âÂèäÂà∞ÁöÑ‰øùÊä§Âå∫Á≠âÁ∫ßÔºåÂèØÂ§öÈÄâ" multiple>
                  <el-option label="‰∏ÄÁ∫ß‰øùÊä§Âå∫" value="‰∏ÄÁ∫ß‰øùÊä§Âå∫"></el-option>
                  <el-option label="‰∫åÁ∫ß‰øùÊä§Âå∫" value="‰∫åÁ∫ß‰øùÊä§Âå∫"></el-option>
                  <el-option label="‰∏âÁ∫ß‰øùÊä§Âå∫" value="‰∏âÁ∫ß‰øùÊä§Âå∫"></el-option>
                  <el-option label="‰∏ÄÁ∫ß‰øùÊä§Âå∫ÔºàÈùûÊ†∏ÂøÉÊôØÂå∫Ôºâ" value="‰∏ÄÁ∫ß‰øùÊä§Âå∫ÔºàÈùûÊ†∏ÂøÉÊôØÂå∫Ôºâ"></el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="È°πÁõÆÂç†Áî®Á±ªÂûã" prop="projectType">
                <el-select v-model="form.projectType" placeholder="ËØ∑ÈÄâÊã©È°πÁõÆÂç†Áî®Á±ªÂûãÔºåÂèØÂ§öÈÄâ" multiple>
                  <el-option label="ÈïøÊúü" value="ÈïøÊúü"></el-option>
                  <el-option label="‰∏¥Êó∂" value="‰∏¥Êó∂"></el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Ê∂âÂèäÈ£éÊôØÂå∫Âú∞‰∏äÂª∫Á≠ëÈù¢ÁßØ(„é°)" prop="scenicGroundArea">
                <el-input v-model="form.scenicGroundArea" placeholder="ËØ∑ËæìÂÖ•È£éÊôØÂå∫Âú∞‰∏äÂª∫Á≠ëÈù¢ÁßØ" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Ê∂âÂèäÈ£éÊôØÂå∫Âú∞‰∏ãÂª∫Á≠ëÈù¢ÁßØ(„é°)" prop="scenicUndergroundArea">
                <el-input v-model="form.scenicUndergroundArea" placeholder="ËØ∑ËæìÂÖ•È£éÊôØÂå∫Âú∞‰∏ãÂª∫Á≠ëÈù¢ÁßØ" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="È°πÁõÆÁî®ÈÄî" prop="projectUsage">
                <el-input v-model="form.projectUsage"
                  placeholder="ËØ∑ËæìÂÖ•È°πÁõÆÁî®ÈÄîÔºå‰æãÂ¶ÇÔºöÊóÖÊ∏∏ÂºÄÂèë„ÄÅÂÖ¨Ë∑Ø„ÄÅÈìÅË∑Ø„ÄÅÊú∫Âú∫„ÄÅÊ∞¥Âà©Ê∞¥Áîµ„ÄÅÁîµÂäõÈÄöËÆØ„ÄÅÈò≤ÁÅæÂáèÁÅæ„ÄÅÂÖ¨Áî®ËÆæÊñΩ„ÄÅÂÖ∂‰ªñ......" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÊãüÈÄâ‰ΩçÁΩÆ" prop="projectPurpose">
                <el-input v-model="form.projectPurpose" placeholder="ËØ∑ËæìÂÖ•ÊãüÈÄâ‰ΩçÁΩÆ" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="Âª∫ËÆæÈ°πÁõÆÊãüÊäïËµÑÈ¢ùÔºà‰∏áÂÖÉÔºâ" prop="projectInvestment">
            <el-input v-model="form.projectInvestment" placeholder="ËØ∑ËæìÂÖ•Âª∫ËÆæÈ°πÁõÆÊÄªÊäïËµÑÈ¢ù" />
          </el-form-item>
          <el-form-item label="ËßÑÂàí‰æùÊçÆ" prop="planningBasis">
            <el-input v-model="form.planningBasis" type="textarea"
              placeholder="ËØ∑ËæìÂÖ•ËßÑÂàí‰æùÊçÆÔºåÂ¶Ç**È£éÊôØÂêçËÉúÂå∫ÊÄª‰ΩìËßÑÂàí**ÊôØÂå∫ËØ¶ÁªÜËßÑÂàí„ÄÇÔºàÊ≤°ÊúâÁ∫≥ÂÖ•È£éÊôØÂêçËÉúÂå∫ËßÑÂàíÁöÑËá™ÁÑ∂ÁÅæÂÆ≥‰øÆÂ§ç„ÄÅÂõΩÈò≤Âª∫ËÆæÁ≠âÁâπÊÆäÁ±ªÈ°πÁõÆÔºåÊàñÁ¨¶Âêà‰∏ìÈ°πËßÑÂàíÁöÑ‰∫§ÈÄö„ÄÅÂ∫óÈáå„ÄÅÈÄöËÆØÁ≠âÂõΩÂÆ∂ÊàñÁúÅÈáçÁÇπÂü∫Á°ÄÂª∫ËÆæÈ°πÁõÆÔºåÈúÄËØ¥ÊòéÊúâÂÖ≥ÊÉÖÂÜµÔºâ" />
          </el-form-item>
          <el-form-item label="Âª∫ËÆæÂÜÖÂÆπÊ∂âÂèäËßÑÊ®°" prop="constructionContent">
            <el-input v-model="form.constructionContent" type="textarea"
              placeholder="ËØ∑ËæìÂÖ•Ê∂âÂèäÁöÑÂÖ∑‰ΩìÂª∫ËÆæÂÜÖÂÆπÔºåËßÑÊ®°‰ø°ÊÅØÂåÖÊã¨È°πÁõÆÁî®Âú∞Èù¢ÁßØ„ÄÅÁ∫øÊÄßÂ∑•Á®ãÈïøÂ∫¶ÂèäÈÖçÂ•óËÆæÊñΩÂç†Âú∞„ÄÅÊûÑÁ≠ëÁâ©ËßÑÊ®°„ÄÅÂª∫Á≠ëÈôêÈ´ò„ÄÅÂÅúËΩ¶‰ΩçÊåáÊ†áÁ≠âÔºåËã•ÊúâÊ∂âÂèäÊñ∞Âª∫„ÄÅÊîπÈÄ†„ÄÅ‰øùÁïôÁöÑÊÉÖÂÜµÔºåÂ∫îÂàÜÂà´Ê≥®ÊòéÁõ∏ÂÖ≥ÊåáÊ†á" />
          </el-form-item>
          <el-form-item label="ÂÖ∂‰ªñÈúÄË¶ÅËØ¥ÊòéÁöÑÊÉÖÂÜµ" prop="otherExplanations">
            <el-input v-model="form.otherExplanations" type="textarea" placeholder="ËØ∑ËæìÂÖ•ÂÖ∂‰ªñÈúÄË¶ÅËØ¥ÊòéÁöÑÊÉÖÂÜµ" />
          </el-form-item>

          <!-- Êñá‰ª∂‰∏ä‰º†Âå∫ÂüüÔºàÊ∑ªÂä† ref Âíå @change ‰∫ã‰ª∂Ôºâ -->
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÈÄâÂùÄÊñπÊ°à" prop="locationPlan">
                <div class="upload-container">
                  <el-upload ref="locationPlanUploadRef" multiple :action="uploadFileUrl"
                    :before-upload="(file) => handleBeforeUpload(file, 'locationPlan')"
                    :file-list="locationPlanFileList" :limit="props.limit" :accept="getFileAccept()"
                    :on-error="(err, file) => handleUploadError(err, file, 'locationPlan')" :on-exceed="handleExceed"
                    :on-success="(res, file) => handleUploadSuccess(res, file, 'locationPlan')"
                    :on-remove="() => handleFileRemove('locationPlan')" :show-file-list="false" :headers="headers"
                    class="upload-file-uploader" :disabled="props.compDisabled">
                    <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                  </el-upload>
                  <transition-group class="upload-file-list el-upload-list el-upload-list--text"
                    name="el-fade-in-linear" tag="ul">
                    <li v-for="(file, index) in locationPlanFileList"
                      :key="file.ossId || `location-${index}-${file.name}`"
                      class="el-upload-list__item ele-upload-list__item-content">
                      <el-link :href="file.url" :underline="false" target="_blank">
                        <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                      </el-link>
                      <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                        <el-button type="danger" link @click.stop="handleDeleteUploadFile(index, 'locationPlan')">
                          Âà†Èô§
                        </el-button>
                      </div>
                    </li>
                  </transition-group>
                </div>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="‰∏ìÂÆ∂ËØÑÂÆ°ÊÑèËßÅ" prop="expertOpinions">
                <div class="upload-container">
                  <el-upload ref="expertOpinionsUploadRef" multiple :action="uploadFileUrl"
                    :before-upload="(file) => handleBeforeUpload(file, 'expertOpinions')"
                    :file-list="expertOpinionsFileList" :limit="props.limit" :accept="getFileAccept()"
                    :on-error="(err, file) => handleUploadError(err, file, 'expertOpinions')" :on-exceed="handleExceed"
                    :on-success="(res, file) => handleUploadSuccess(res, file, 'expertOpinions')"
                    :on-remove="() => handleFileRemove('expertOpinions')" :show-file-list="false" :headers="headers"
                    class="upload-file-uploader" :disabled="props.compDisabled">
                    <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                  </el-upload>
                  <transition-group class="upload-file-list el-upload-list el-upload-list--text"
                    name="el-fade-in-linear" tag="ul">
                    <li v-for="(file, index) in expertOpinionsFileList"
                      :key="file.ossId || `expert-${index}-${file.name}`"
                      class="el-upload-list__item ele-upload-list__item-content">
                      <el-link :href="file.url" :underline="false" target="_blank">
                        <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                      </el-link>
                      <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                        <el-button type="danger" link @click.stop="handleDeleteUploadFile(index, 'expertOpinions')">
                          Âà†Èô§
                        </el-button>
                      </div>
                    </li>
                  </transition-group>
                </div>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÂÖ¨Á§∫ÊùêÊñô" prop="meetingMaterials">
                <div class="upload-container">
                  <el-upload ref="meetingMaterialsUploadRef" multiple :action="uploadFileUrl"
                    :before-upload="(file) => handleBeforeUpload(file, 'meetingMaterials')"
                    :file-list="meetingMaterialsFileList" :limit="props.limit" :accept="getFileAccept()"
                    :on-error="(err, file) => handleUploadError(err, file, 'meetingMaterials')"
                    :on-exceed="handleExceed"
                    :on-success="(res, file) => handleUploadSuccess(res, file, 'meetingMaterials')"
                    :on-remove="() => handleFileRemove('meetingMaterials')" :show-file-list="false" :headers="headers"
                    class="upload-file-uploader" :disabled="props.compDisabled">
                    <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                  </el-upload>
                  <transition-group class="upload-file-list el-upload-list el-upload-list--text"
                    name="el-fade-in-linear" tag="ul">
                    <li v-for="(file, index) in meetingMaterialsFileList" :key="file.ossId"
                      class="el-upload-list__item ele-upload-list__item-content">
                      <el-link :href="file.url" :underline="false" target="_blank">
                        <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                      </el-link>
                      <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                        <el-button type="danger" link @click="handleDeleteUploadFile(index, 'meetingMaterials')">
                          Âà†Èô§
                        </el-button>
                      </div>
                    </li>
                  </transition-group>
                </div>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÈÄâÂùÄÊñπÊ°àÊ†∏ÂáÜÁî≥Êä•Ë°®" prop="siteSelectionReport">
                <div class="upload-container">
                  <el-upload ref="siteSelectionReportUploadRef" multiple :action="uploadFileUrl"
                    :before-upload="(file) => handleBeforeUpload(file, 'siteSelectionReport')"
                    :file-list="siteSelectionReportFileList" :limit="props.limit" :accept="getFileAccept()"
                    :on-error="(err, file) => handleUploadError(err, file, 'siteSelectionReport')"
                    :on-exceed="handleExceed"
                    :on-success="(res, file) => handleUploadSuccess(res, file, 'siteSelectionReport')"
                    :on-remove="() => handleFileRemove('siteSelectionReport')" :show-file-list="false"
                    :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                    <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                  </el-upload>
                  <transition-group class="upload-file-list el-upload-list el-upload-list--text"
                    name="el-fade-in-linear" tag="ul">
                    <li v-for="(file, index) in siteSelectionReportFileList" :key="file.ossId"
                      class="el-upload-list__item ele-upload-list__item-content">
                      <el-link :href="file.url" :underline="false" target="_blank">
                        <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                      </el-link>
                      <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                        <el-button type="danger" link @click="handleDeleteUploadFile(index, 'siteSelectionReport')">
                          Âà†Èô§
                        </el-button>
                      </div>
                    </li>
                  </transition-group>
                </div>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Á´ãÈ°πÊñá‰ª∂" prop="approvalDocuments">
                <div class="upload-container">
                  <el-upload ref="approvalDocumentsUploadRef" multiple :action="uploadFileUrl"
                    :before-upload="(file) => handleBeforeUpload(file, 'approvalDocuments')"
                    :file-list="approvalDocumentsFileList" :limit="props.limit" :accept="getFileAccept()"
                    :on-error="(err, file) => handleUploadError(err, file, 'approvalDocuments')"
                    :on-exceed="handleExceed"
                    :on-success="(res, file) => handleUploadSuccess(res, file, 'approvalDocuments')"
                    :show-file-list="false" :headers="headers" class="upload-file-uploader"
                    :disabled="props.compDisabled">
                    <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                  </el-upload>
                  <transition-group class="upload-file-list el-upload-list el-upload-list--text"
                    name="el-fade-in-linear" tag="ul">
                    <li v-for="(file, index) in approvalDocumentsFileList" :key="file.ossId"
                      class="el-upload-list__item ele-upload-list__item-content">
                      <el-link :href="file.url" :underline="false" target="_blank">
                        <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                      </el-link>
                      <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                        <el-button type="danger" link @click="handleDeleteUploadFile(index, 'approvalDocuments')">
                          Âà†Èô§
                        </el-button>
                      </div>
                    </li>
                  </transition-group>
                </div>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="È°πÁõÆÁî®Âú∞Á∫¢Á∫øÂõæ" prop="projectRedLine">
                <div class="upload-container">
                  <el-upload ref="projectRedLineUploadRef" multiple :action="uploadFileUrl"
                    :before-upload="(file) => handleBeforeUpload(file, 'projectRedLine')"
                    :file-list="projectRedLineFileList" :limit="props.limit" :accept="getFileAccept()"
                    :on-error="(err, file) => handleUploadError(err, file, 'projectRedLine')" :on-exceed="handleExceed"
                    :on-success="(res, file) => handleUploadSuccess(res, file, 'projectRedLine')"
                    :on-remove="() => handleFileRemove('projectRedLine')" :show-file-list="false" :headers="headers"
                    class="upload-file-uploader" :disabled="props.compDisabled">
                    <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                  </el-upload>
                  <transition-group class="upload-file-list el-upload-list el-upload-list--text"
                    name="el-fade-in-linear" tag="ul">
                    <li v-for="(file, index) in projectRedLineFileList" :key="file.ossId"
                      class="el-upload-list__item ele-upload-list__item-content">
                      <el-link :href="file.url" :underline="false" target="_blank">
                        <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                      </el-link>
                      <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                        <el-button type="danger" link @click="handleDeleteUploadFile(index, 'projectRedLine')">
                          Âà†Èô§
                        </el-button>
                      </div>
                    </li>
                  </transition-group>
                </div>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="È°πÁõÆÁ∫¢Á∫øÁü¢ÈáèÊï∞ÊçÆ" prop="redLineCoordinate">
            <div class="upload-container">
              <el-upload ref="redLineCoordinateUploadRef" multiple :action="redLineUploadUrl"
                :before-upload="(file) => handleBeforeUpload(file, 'redLineCoordinate')"
                :file-list="redLineCoordinateFileList" :limit="props.limit" accept=".zip"
                :on-error="(err, file) => handleUploadError(err, file, 'redLineCoordinate')" :on-exceed="handleExceed"
                :on-success="(res, file) => handleUploadSuccess(res, file, 'redLineCoordinate')"
                :on-remove="() => handleFileRemove('redLineCoordinate')" :show-file-list="false" :headers="headers"
                class="upload-file-uploader" :disabled="props.compDisabled">
                <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
              </el-upload>
              <div class="operation-group">
                <el-button link type="primary" @click="handleDownloadTemplate('instructions')">Â°´ÂÜôËØ¥Êòé</el-button>
                <el-button link type="primary" @click="handleDownloadTemplate('polygonTemplate')">Èù¢Ê®°Êùø‰∏ãËΩΩ</el-button>
                <el-button link type="primary" @click="handleDownloadTemplate('polylineTemplate')">Á∫øÊ®°Êùø‰∏ãËΩΩ</el-button>
                <div>Ôºà‰ΩøÁî®ÂâçÔºåËØ∑Âà†Èô§Ê®°Êùø‰∏≠ÁöÑÂÆû‰æãÊï∞ÊçÆÔºâ</div>
              </div>
              <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                tag="ul">
                <li v-for="(file, index) in redLineCoordinateFileList" :key="file.ossId"
                  class="el-upload-list__item ele-upload-list__item-content">
                  <el-link :href="file.url" :underline="false" target="_blank">
                    <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                  </el-link>
                  <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                    <el-button type="danger" link @click="handleDeleteUploadFile(index, 'redLineCoordinate')">
                      Âà†Èô§
                    </el-button>
                  </div>
                </li>
              </transition-group>
            </div>
          </el-form-item>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="È°πÁõÆ‰∏âÁª¥Ê®°Âûã" prop="threeDModel">
                <div class="upload-container">
                  <el-upload ref="threeDModelUploadRef" multiple :action="uploadFileUrl"
                    :before-upload="(file) => handleBeforeUpload(file, 'threeDModel')" :file-list="threeDModelFileList"
                    :limit="props.limit" :accept="getFileAccept()"
                    :on-error="(err, file) => handleUploadError(err, file, 'threeDModel')" :on-exceed="handleExceed"
                    :on-success="(res, file) => handleUploadSuccess(res, file, 'threeDModel')"
                    :on-remove="() => handleFileRemove('threeDModel')" :show-file-list="false" :headers="headers"
                    class="upload-file-uploader" :disabled="props.compDisabled"
                    :on-progress="(progressEvent, file) => handleUploadProgress(progressEvent, file, 'threeDModel')">
                    <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                  </el-upload>
                  <div class="operation-group">
                    <el-button link type="primary" icon="Download"
                      @click="handleDownloadTemplate('threeD')">Ê®°ÂûãËßÑËåÉ‰∏éÊ®°Êùø‰∏ãËΩΩ</el-button>
                  </div>
                  <!-- ‰∏âÁª¥Ê®°Âûã‰∏ä‰º†ËøõÂ∫¶Êù° -->
                  <div v-for="(item, index) in threeDModelUploadProgress" :key="`progress-${index}-${item.fileName}`"
                    class="upload-progress-container">
                    <div class="progress-file-name">{{ item.fileName }}<span v-if="item.progressText"
                        class="progress-text">{{ item.progressText }}</span></div>
                    <el-progress :percentage="item.progress" :status="item.status" :stroke-width="6"
                      class="upload-progress-bar" />
                  </div>
                  <transition-group class="upload-file-list el-upload-list el-upload-list--text"
                    name="el-fade-in-linear" tag="ul">
                    <li v-for="(file, index) in threeDModelFileList" :key="file.ossId"
                      class="el-upload-list__item ele-upload-list__item-content">
                      <el-link :href="file.url" :underline="false" target="_blank">
                        <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                      </el-link>
                      <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                        <el-button type="danger" link @click="handleDeleteUploadFile(index, 'threeDModel')">
                          Âà†Èô§
                        </el-button>
                      </div>
                    </li>
                  </transition-group>
                </div>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Ê®°ÂûãÂùêÊ†á" prop="modelCoordinate">
                <div class="upload-container">
                  <el-input v-model="form.modelCoordinate" placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãÂùêÊ†áÊ†ºÂºè‰∏∫ÔºöÁªèÂ∫¶,Á∫¨Â∫¶,È´òÂ∫¶,ÊóãËΩ¨ÊñπÂêë" />
                </div>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </div>
    <el-dialog v-model="dialogVisible" :title="dialogTitle" width="800px" center class="validation-dialog"
      destroy-on-close>
      <div class="validation-content">
        <!-- È™åËØÅÈÄöËøáÊèêÁ§∫ -->
        <div v-if="dialogErrors.length === 0" class="success-tip">
          ‚úÖ Êï∞ÊçÆÈ™åËØÅÈÄöËøáÔºåÊó†ÈîôËØØ‰ø°ÊÅØ
        </div>
        <!-- È™åËØÅÂ§±Ë¥•ÈîôËØØÂàóË°® -->
        <div v-else class="error-list">
          <div v-for="(error, index) in dialogErrors" :key="index" class="error-item">
            {{ index + 1 }}. Êä•ÈîôÂ≠óÊÆµ„Äê{{ error.fieldName || 'Êú™Áü•Â≠óÊÆµ' }}„ÄëÊä•Èîô‰ø°ÊÅØÔºö{{ error.errorMessage }}
          </div>
        </div>
      </div>
    </el-dialog>
    <div class="add-footer">
      <el-button @click="cancel">ÂèñÊ∂à</el-button>
      <el-button type="warning" @click="resetForm">ÈáçÁΩÆ</el-button>
      <el-button type="success" v-hasPermi="['project:project:stage']" @click="temporarilyForm">ÊöÇÂ≠ò</el-button>
      <el-button :loading="buttonLoading" type="primary" @click="submitForm">Êèê‰∫§</el-button>
    </div>
  </div>
  <div class="add-content-container" v-else>
    <div class="popup-content">
      <img src="@/assets/images/tick.png" class="success-icon" />
      <div class="success-text">Áî≥Êä•‰ø°ÊÅØÂ∑≤ÊàêÂäüÊèê‰∫§ÔºÅ</div>
      <div class="button-group">
        <el-button class="btn-back" @click="handleBackToList">ËøîÂõûÈ°πÁõÆÂàóË°®</el-button>
        <el-button class="btn-view" @click="handleViewDetail">Êü•ÁúãÂ°´Êä•ËØ¶ÊÉÖ</el-button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, getCurrentInstance } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { getInfo, stageInfo, submitInfo } from '@/api/project/normal/index';
import { delOss, listByIds } from '@/api/system/oss';
import { useUserStore } from '@/store/modules/user'
import { propTypes } from '@/utils/propTypes';
import { ElMessage, ElForm } from 'element-plus'
import { globalHeaders } from '@/utils/request';
const { proxy } = getCurrentInstance() || {}
const router = useRouter()
const route = useRoute()

// ÂàùÂßãÂåñ Pinia ÂÆû‰æã
const userStore = useUserStore()
const declartionInformation = ref(true)
// ‰∏âÁª¥Ê®°Âûã‰∏ä‰º†ËøõÂ∫¶Êù°Áä∂ÊÄÅÁÆ°ÁêÜ
const threeDModelUploadProgress = ref([])
// ÂÆö‰πâÁªÑ‰ª∂Â±ûÊÄß
const props = defineProps({
  // Êï∞ÈáèÈôêÂà∂
  limit: propTypes.number.def(15),
  // Â§ßÂ∞èÈôêÂà∂(MB)
  fileSize: propTypes.number.def(500),
  // Êñá‰ª∂Á±ªÂûã
  fileType: propTypes.array.def([
    'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'pdf', 'zip', 'rar',
    'dwg', 'dxf', 'jpg', 'jpeg', 'png', 'cpg', 'dbf', 'prj', 'sbn', 'sbx',
    'shp', 'shp.xml', 'shx', 'FBX', 'fbm', 'obj', 'pak'
  ]),
  compDisabled: {
    type: Boolean,
    default: false
  }
});
// ========== Êñ∞Â¢ûÔºöSHPÈ™åËØÅÂºπÁ™óÁõ∏ÂÖ≥Êï∞ÊçÆ ==========
const dialogVisible = ref(false) // ÂºπÁ™óÊòæÈöê
const dialogTitle = ref('')      // ÂºπÁ™óÊ†áÈ¢ò
const dialogErrors = ref([])     // È™åËØÅÈîôËØØÂàóË°®
// ==============================================
const basicFormRef = ref(null)
const infoFormRef = ref(null)
// ÊåâÈíÆÂä†ËΩΩÁä∂ÊÄÅ
const buttonLoading = ref(false)
const isTemporarilySaved = ref(false)
// ÁªÑ‰ª∂Áä∂ÊÄÅ
const form = reactive({
  id: undefined,
  projectName: undefined,
  projectCode: undefined,
  administrativeRegion: undefined,
  scenicArea: undefined,
  applicantType: 'Âçï‰Ωç',
  constructionUnit: undefined,
  organizationCode: undefined,
  contactPerson: undefined,
  contactPhone: undefined,
  protectionLevel: [],
  status: undefined,
  projectType: [],
  projectUsage: undefined,
  projectPurpose: undefined,
  createTime: undefined,
  updateTime: undefined,
  projectInvestment: undefined,
  planningBasis: undefined,
  constructionContent: undefined,
  otherExplanations: undefined,
  locationPlan: '',
  expertOpinions: '',
  meetingMaterials: '',
  siteSelectionReport: '',
  approvalDocuments: '',
  projectRedLine: '',
  redLineCoordinate: '',
  threeDModel: '',
  modelCoordinate: undefined,
  majorFlag: false,
  scenicGroundArea: undefined,
  scenicUndergroundArea: undefined,
})

// Êñá‰ª∂ÂàóË°®ÔºàÁî®‰∫éÊ†°È™åÊòØÂê¶‰∏ä‰º†Ôºâ
const locationPlanFileList = ref([])
const expertOpinionsFileList = ref([])
const meetingMaterialsFileList = ref([])
const siteSelectionReportFileList = ref([])
const approvalDocumentsFileList = ref([])
const projectRedLineFileList = ref([])
const redLineCoordinateFileList = ref([])
const threeDModelFileList = ref([])
// È°πÁõÆÁî®ÈÄîÁôΩÂêçÂçïÔºà‰∏•Ê†ºÂåπÈÖç‰Ω†ÁöÑË¶ÅÊ±ÇÔºâ
const projectUsageWhiteList = [
  'ÂÖ¨Ë∑Ø', 'ÈìÅË∑Ø', 'Êú∫Âú∫', 'Ê∞¥Âà©Ê∞¥Áîµ', 'ÁîµÂäõÈÄöËÆØ', 'Ê≤πÊ∞îÁÆ°ÁΩë',
  'ÁßëÊäÄ„ÄÅÊïôËÇ≤', 'ÂÖ¨Áî®ËÆæÊñΩ', '‰π°ÊùëÈÅìË∑Ø', '‰øùÈöúÊÄß‰ΩèÊàøÊàñÁßªÊ∞ëÊê¨ËøÅ',
  'ÂÜúÊ∞ëËá™Âª∫Âü∫Êú¨Áîü‰∫ßÁîüÊ¥ªÊàøËàç', 'ÂïÜ‰∏öÊúçÂä°‰∏ö', 'Áâ©ÊµÅ‰ªìÂÇ®', 'ÊóÖÊ∏∏ÂºÄÂèë',
  'ÂÖªÊÆñ', 'ÊªëÈõ™Âú∫', 'Êûó‰∏öÁîü‰∫ßÁªèËê•„ÄÅÁßëÁ†îÁßëÊôÆÊúçÂä°ËÆæÊñΩ', 'ÂÖ∂‰ªñ'
]
// Ë°®ÂçïÈ™åËØÅËßÑÂàôÔºàÊ†∏ÂøÉÔºöÊ∑ªÂä†Êñá‰ª∂‰∏ä‰º†Ëá™ÂÆö‰πâÊ†°È™åÔºâ
const rules = reactive({
  projectName: [{ required: true, message: 'ËØ∑ËæìÂÖ•Âª∫ËÆæÈ°πÁõÆÂêçÁß∞', trigger: 'blur' }],
  administrativeRegion: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÊâÄÂ±ûË°åÊîøÂå∫Âàí', trigger: 'blur' }],
  scenicArea: [{ required: true, message: 'ËØ∑ËæìÂÖ•Ê∂âÂèäÈ£éÊôØÂêçËÉúÂå∫ÂêçÁß∞', trigger: 'blur' }],
  applicantType: [{ required: true, message: 'ËØ∑ÈÄâÊã©Âª∫ËÆæÁ±ªÂûã', trigger: 'change' }],
  constructionUnit: [{ required: true, message: 'ËØ∑ËæìÂÖ•Âª∫ËÆæÂçï‰ΩçÂêçÁß∞', trigger: 'blur' }],
  organizationCode: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÁªÑÁªáÊú∫ÊûÑ‰ª£Á†Å', trigger: 'blur' }],
  contactPerson: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫', trigger: 'blur' }],
  contactPhone: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫ËÅîÁ≥ªÊñπÂºè', trigger: 'blur' },
    {
      pattern: /^(1[3-9]\d{9}|0\d{2,3}-\d{7,8})$/,
      message: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Á†ÅÊàñÂõ∫ËØùÔºàÂ¶Ç010-12345678Ôºâ',
      trigger: 'blur'
    }
  ],
  protectionLevel: [{ required: true, message: 'ËØ∑ÈÄâÊã©‰øùÊä§Âå∫Á≠âÁ∫ß', trigger: 'change' }],
  projectType: [{ required: true, message: 'ËØ∑ÈÄâÊã©È°πÁõÆÂç†Áî®Á±ªÂûã', trigger: 'change' }],
  scenicGroundArea: [
    { required: true, message: 'ËØ∑ËæìÂÖ•È£éÊôØÂå∫Âú∞‰∏äÂª∫Á≠ëÈù¢ÁßØ', trigger: 'blur' },
    {
      pattern: /^\d+(\.\d+)?$/, // ÊîØÊåÅÊ≠£Êï¥Êï∞/Ê≠£Â∞èÊï∞ÔºàÈù¢ÁßØ‰∏çËÉΩ‰∏∫Ë¥üÔºâ
      message: 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠óÔºàÊîØÊåÅÊï¥Êï∞ÊàñÂ∞èÊï∞Ôºâ',
      trigger: 'blur'
    }
  ],
  scenicUndergroundArea: [
    { required: true, message: 'ËØ∑ËæìÂÖ•È£éÊôØÂå∫Âú∞‰∏ãÂª∫Á≠ëÈù¢ÁßØ', trigger: 'blur' },
    {
      pattern: /^\d+(\.\d+)?$/, // ÊîØÊåÅÊ≠£Êï¥Êï∞/Ê≠£Â∞èÊï∞ÔºàÈù¢ÁßØ‰∏çËÉΩ‰∏∫Ë¥üÔºâ
      message: 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠óÔºàÊîØÊåÅÊï¥Êï∞ÊàñÂ∞èÊï∞Ôºâ',
      trigger: 'blur'
    }
  ],
  projectUsage: [
    { required: true, message: 'ËØ∑ËæìÂÖ•È°πÁõÆÁî®ÈÄî', trigger: 'blur' },
    {
      validator: (rule, value, callback) => {
        // ÂéªÈô§È¶ñÂ∞æÁ©∫Ê†ºÂêéÂà§Êñ≠ÊòØÂê¶Âú®ÁôΩÂêçÂçï‰∏≠
        const inputValue = value ? value.trim() : ''
        if (inputValue && !projectUsageWhiteList.includes(inputValue)) {
          callback(new Error(
            'È°πÁõÆÁî®ÈÄîÂè™ËÉΩËæìÂÖ•ÔºöÂÖ¨Ë∑Ø„ÄÅÈìÅË∑Ø„ÄÅÊú∫Âú∫„ÄÅÊ∞¥Âà©Ê∞¥Áîµ„ÄÅÁîµÂäõÈÄöËÆØ„ÄÅÊ≤πÊ∞îÁÆ°ÁΩë„ÄÅÁßëÊäÄ„ÄÅÊïôËÇ≤„ÄÅÂÖ¨Áî®ËÆæÊñΩ„ÄÅ‰π°ÊùëÈÅìË∑Ø„ÄÅ‰øùÈöúÊÄß‰ΩèÊàøÊàñÁßªÊ∞ëÊê¨ËøÅ„ÄÅÂÜúÊ∞ëËá™Âª∫Âü∫Êú¨Áîü‰∫ßÁîüÊ¥ªÊàøËàç„ÄÅÂïÜ‰∏öÊúçÂä°‰∏ö„ÄÅÁâ©ÊµÅ‰ªìÂÇ®„ÄÅÊóÖÊ∏∏ÂºÄÂèë„ÄÅÂÖªÊÆñ„ÄÅÊªëÈõ™Âú∫„ÄÅÊûó‰∏öÁîü‰∫ßÁªèËê•„ÄÅÁßëÁ†îÁßëÊôÆÊúçÂä°ËÆæÊñΩ„ÄÅÂÖ∂‰ªñ'
          ))
        } else {
          callback()
        }
      },
      trigger: ['blur', 'change']
    }],
  projectPurpose: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÊãüÈÄâ‰ΩçÁΩÆ', trigger: 'blur' }],
  projectInvestment: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Âª∫ËÆæÈ°πÁõÆÊãüÊäïËµÑÈ¢ù', trigger: 'blur' },
    { pattern: /^\d+(\.\d+)?$/, message: 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠óÔºàÊîØÊåÅÊï¥Êï∞ÊàñÂ∞èÊï∞ÔºåÈáëÈ¢ù‰∏çËÉΩ‰∏∫Ë¥üÔºâ', trigger: 'blur' }
  ],
  planningBasis: [{ required: true, message: 'ËØ∑ËæìÂÖ•ËßÑÂàí‰æùÊçÆ', trigger: 'blur' }],
  constructionContent: [{ required: true, message: 'ËØ∑ËæìÂÖ•Âª∫ËÆæÂÜÖÂÆπÊ∂âÂèäËßÑÊ®°', trigger: 'blur' }],
  // Êñá‰ª∂‰∏ä‰º†Â≠óÊÆµÔºöËá™ÂÆö‰πâÊ†°È™åÔºàÁ°Æ‰øùËá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂Ôºâ
  locationPlan: [
    { required: true, message: 'ËØ∑‰∏ä‰º†ÈÄâÂùÄÊñπÊ°à', trigger: ['change', 'blur'] },
    {
      validator: (rule, value, callback) => {
        if (locationPlanFileList.value.length > 0) {
          callback() // ‰∏ä‰º†‰∫ÜÊñá‰ª∂ÔºåÊ†°È™åÈÄöËøá
        } else {
          callback(new Error('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂')) // Êú™‰∏ä‰º†ÔºåÊ†°È™åÂ§±Ë¥•
        }
      },
      trigger: ['change', 'blur']
    }
  ],
  expertOpinions: [
    { required: true, message: 'ËØ∑‰∏ä‰º†‰∏ìÂÆ∂ËØÑÂÆ°ÊÑèËßÅ', trigger: ['change', 'blur'] },
    {
      validator: (rule, value, callback) => {
        if (expertOpinionsFileList.value.length > 0) {
          callback()
        } else {
          callback(new Error('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂'))
        }
      },
      trigger: ['change', 'blur']
    }
  ],
  meetingMaterials: [
    { required: true, message: 'ËØ∑‰∏ä‰º†ÂÖ¨Á§∫ÊùêÊñô', trigger: ['change', 'blur'] },
    {
      validator: (rule, value, callback) => {
        // Áõ¥Êé•Ê†°È™åÊñá‰ª∂ÂàóË°®ÈïøÂ∫¶ÔºåÊó†ÈúÄ‰æùËµñ form Â≠óÊÆµ
        if (meetingMaterialsFileList.value.length > 0) {
          callback() // ‰∏ä‰º†‰∫ÜÊñá‰ª∂ÔºåÊ†°È™åÈÄöËøá
        } else {
          callback(new Error('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂')) // Êú™‰∏ä‰º†ÔºåÊ†°È™åÂ§±Ë¥•
        }
      },
      trigger: ['change', 'blur'] // Â¢ûÂä†‰∏ä‰º†Áõ∏ÂÖ≥Ëß¶ÂèëÊó∂Êú∫
    }
  ],
  siteSelectionReport: [
    { required: true, message: 'ËØ∑‰∏ä‰º†ÈÄâÂùÄÊñπÊ°àÊ†∏ÂáÜÁî≥Êä•Ë°®', trigger: ['change', 'blur'] },
    {
      validator: (rule, value, callback) => {
        if (siteSelectionReportFileList.value.length > 0) {
          callback()
        } else {
          callback(new Error('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂'))
        }
      },
      trigger: ['change', 'blur']
    }
  ],
  projectRedLine: [
    { required: true, message: 'ËØ∑‰∏ä‰º†È°πÁõÆÁî®Âú∞Á∫¢Á∫øÂõæ', trigger: ['change', 'blur'] },
    {
      validator: (rule, value, callback) => {
        if (projectRedLineFileList.value.length > 0) {
          callback()
        } else {
          callback(new Error('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂'))
        }
      },
      trigger: ['change', 'blur']
    }
  ],
  redLineCoordinate: [
    { required: true, message: 'ËØ∑‰∏ä‰º†È°πÁõÆÁ∫¢Á∫øÁü¢ÈáèÊï∞ÊçÆ', trigger: ['change', 'blur'] },
    {
      validator: (rule, value, callback) => {
        if (redLineCoordinateFileList.value.length > 0) {
          callback()
        } else {
          callback(new Error('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂'))
        }
      },
      trigger: ['change', 'blur']
    }
  ],
  threeDModel: [
    { required: true, message: 'ËØ∑‰∏ä‰º†È°πÁõÆ‰∏âÁª¥Ê®°Âûã', trigger: ['change', 'blur'] },
    {
      validator: (rule, value, callback) => {
        if (threeDModelFileList.value.length > 0) {
          callback()
        } else {
          callback(new Error('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂'))
        }
      },
      trigger: ['change', 'blur']
    }
  ],
  modelCoordinate: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Ê®°ÂûãÂùêÊ†á', trigger: 'blur' },
    {
      pattern: /^-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?$/,
      message: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÊ†ºÂºèÔºàÁªèÂ∫¶,Á∫¨Â∫¶,È´òÂ∫¶,ÊóãËΩ¨ÊñπÂêëÔºâÔºåÊîØÊåÅÊ≠£Ë¥üÂ∞èÊï∞',
      trigger: 'blur'
    }
  ]
})

// Ëé∑ÂèñÊñá‰ª∂ÂêçÔºàÂ§ÑÁêÜË∑ØÂæÑÔºâ
const getFileName = (name) => {
  if (!name) return 'Êú™Áü•Êñá‰ª∂';
  const lastSlashIndex = Math.max(name.lastIndexOf('/'), name.lastIndexOf('\\'));
  return lastSlashIndex > -1 ? name.slice(lastSlashIndex + 1) : name;
};

// ‰∏ä‰º†Áõ∏ÂÖ≥ÈÖçÁΩÆ
const uploadFileUrl = import.meta.env.VITE_APP_BASE_API + '/resource/oss/upload'
const redLineUploadUrl = import.meta.env.VITE_APP_BASE_API + '/resource/oss/uploadShp'
const headers = computed(() => globalHeaders())

// Ëé∑ÂèñÊñá‰ª∂Êé•ÂèóÁ±ªÂûã
const getFileAccept = () => {
  return props.fileType.map(type => `.${type.toLowerCase()}`).join(',')
}

// ÁîüÂëΩÂë®ÊúüÔºöÂàùÂßãÂåñÊó∂Âä†ËΩΩÊï∞ÊçÆ
onMounted(async () => {
  const projectId = route.params.id
  if (!projectId) {
    ElMessage.error('Áº∫Â∞ëÈ°πÁõÆIDÔºåÊó†Ê≥ïÂä†ËΩΩÊï∞ÊçÆ')
    router.push('/project/normal')
    return
  }

  try {
    const response = await getInfo(projectId)
    const projectData = response.data
    Object.assign(form, projectData)
    form.protectionLevel = projectData.protectionLevel ? (Array.isArray(projectData.protectionLevel) ? projectData.protectionLevel : projectData.protectionLevel.split(',').filter(Boolean)) : []
    form.projectType = projectData.projectType ? (Array.isArray(projectData.projectType) ? projectData.projectType : projectData.projectType.split(',').filter(Boolean)) : []
    // Ëß£ÊûêÊñá‰ª∂ÂàóË°®
    if (projectData.locationPlan) {
      locationPlanFileList.value = JSON.parse(projectData.locationPlan)
    }
    if (projectData.expertOpinions) {
      expertOpinionsFileList.value = JSON.parse(projectData.expertOpinions)
    }
    if (projectData.meetingMaterials) {
      meetingMaterialsFileList.value = JSON.parse(projectData.meetingMaterials)
    }
    if (projectData.siteSelectionReport) {
      siteSelectionReportFileList.value = JSON.parse(projectData.siteSelectionReport)
    }
    if (projectData.approvalDocuments) {
      approvalDocumentsFileList.value = JSON.parse(projectData.approvalDocuments)
    }
    if (projectData.projectRedLine) {
      projectRedLineFileList.value = JSON.parse(projectData.projectRedLine)
    }
    if (projectData.redLineCoordinate) {
      redLineCoordinateFileList.value = JSON.parse(projectData.redLineCoordinate)
    }
    if (projectData.threeDModel) {
      threeDModelFileList.value = JSON.parse(projectData.threeDModel)
      if (threeDModelFileList.value.length > 0) {
        form.threeDModel = threeDModelFileList.value[0].url
        // ‰ºòÂåñÔºöÊ∏ÖÁ©∫ÊóßËøõÂ∫¶Êù°ÔºåÈáçÊñ∞ÂàùÂßãÂåñÔºàÈÅøÂÖçÈáçÂ§çÔºâ
        threeDModelUploadProgress.value = []
        threeDModelFileList.value.forEach(file => {
          threeDModelUploadProgress.value.push({
            fileName: getFileName(file.name),
            progress: 100,
            status: 'success',
            fileId: file.ossId,
            progressText: ''
          })
        })
      }
    }
  } catch (err) {
    ElMessage.error('Âä†ËΩΩÈ°πÁõÆÊï∞ÊçÆÂ§±Ë¥•Ôºö' + (err.message || 'Êú™Áü•ÈîôËØØ'))
    router.push('/project/normal')
  }
})

// ‰∏ä‰º†ÂâçÁΩÆÊ†°È™å
const handleBeforeUpload = (file, type) => {
  const fileExt = file.name.split('.').pop()?.toLowerCase() || '';
  // Á±ªÂûãÊ†°È™å
  if (!props.fileType.includes(fileExt)) {
    proxy?.$modal.msgError(`ËØ∑‰∏ä‰º†${props.fileType.join('/')}Ê†ºÂºèÊñá‰ª∂!`);
    return false;
  }
  // Êñá‰ª∂ÂêçÁâπÊÆäÂ≠óÁ¨¶Ê†°È™å
  if (file.name.includes(',')) {
    proxy?.$modal.msgError('Êñá‰ª∂Âêç‰∏çËÉΩÂåÖÂê´Ëã±ÊñáÈÄóÂè∑!');
    return false;
  }
  // Â§ßÂ∞èÊ†°È™å
  const isLtMaxSize = file.size / 1024 / 1024 < props.fileSize
  if (!isLtMaxSize) {
    ElMessage.error(`Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá ${props.fileSize}MB!`)
    return false
  }
  // Ê†∏ÂøÉ‰øÆÊîπ3ÔºöÂçïÁã¨Ê†°È™åÈ°πÁõÆÁ∫¢Á∫øÁü¢ÈáèÊï∞ÊçÆ‰ªÖÂÖÅËÆ∏zipÊ†ºÂºè
  if (type === 'redLineCoordinate') {
    const fileExt = file.name.split('.').pop()?.toLowerCase()
    if (fileExt !== 'zip') {
      ElMessage.error('È°πÁõÆÁ∫¢Á∫øÁü¢ÈáèÊï∞ÊçÆ‰ªÖÊîØÊåÅ‰∏ä‰º†ZIPÊ†ºÂºèÊñá‰ª∂ÔºÅ')
      return false
    }
    return true // Ë∑≥ËøáÈÄöÁî®Á±ªÂûãÊ†°È™å
  }
  if (type === 'threeDModel') {
    const fileName = getFileName(file.name)
    // Èò≤Ê≠¢ÈáçÂ§çÊ∑ªÂä†
    const exists = threeDModelUploadProgress.value.some(item => item.fileName === fileName)
    if (!exists) {
      threeDModelUploadProgress.value.push({
        fileName,
        progress: 0,
        status: undefined, // ‰∏ä‰º†‰∏≠
        fileId: '',
        fileObj: file, // ‰øùÂ≠òÊñá‰ª∂ÂØπË±°ÔºåÁî®‰∫éÂêéÁª≠ÂåπÈÖç
        progressText: 'Ôºà‰∏ä‰º†‰∏≠...Ôºâ' // ÂàùÂßãÂåñËøõÂ∫¶ÊñáÊú¨
      })
    }
  }
  return true
}

// ‰∏ä‰º†ÈîôËØØÂ§ÑÁêÜ
const handleUploadError = (err, file, type) => {
  // ÈíàÂØπSHP‰∏ä‰º†ÁöÑÈîôËØØÂºπÁ™óÂ§ÑÁêÜ
  if (type === 'redLineCoordinate') {
    dialogTitle.value = 'SHPÊï∞ÊçÆ‰∏ä‰º†Â§±Ë¥•'
    dialogErrors.value = [{ fieldName: '‰∏ä‰º†ÊµÅÁ®ã', errorMessage: err.message || '‰∏ä‰º†ËøáÁ®ã‰∏≠ÂèëÁîüÁΩëÁªú/ÊúçÂä°Âô®ÈîôËØØ' }]
    dialogVisible.value = true // Âº∫Âà∂ÊòæÁ§∫ÂºπÁ™ó
  }
  ElMessage.error(`‰∏ä‰º†Â§±Ë¥•: ${err.message || 'Êú™Áü•ÈîôËØØ'}`)
  // ‰∏âÁª¥Ê®°Âûã‰∏ä‰º†Â§±Ë¥•Êó∂Êõ¥Êñ∞ËøõÂ∫¶Êù°Áä∂ÊÄÅ
  if (type === 'threeDModel') {
    const fileName = getFileName(file.name)
    const existingIndex = threeDModelUploadProgress.value.findIndex(
      item => item.fileName === fileName
    )

    if (existingIndex > -1) {
      threeDModelUploadProgress.value[existingIndex] = {
        ...threeDModelUploadProgress.value[existingIndex],
        status: 'exception',
        fileObj: null
      }
    }
  }
}
const handleUploadProgress = (progressEvent, file, type) => {
  if (type !== 'threeDModel') return // Âè™Â§ÑÁêÜ‰∏âÁª¥Ê®°Âûã‰∏ä‰º†ËøõÂ∫¶
  const percent = Math.round((progressEvent.loaded / progressEvent.total) * 100)
  const fileName = getFileName(file.name)

  // Êü•ÊâæÂΩìÂâçÊñá‰ª∂ÁöÑËøõÂ∫¶ËÆ∞ÂΩï
  const existingIndex = threeDModelUploadProgress.value.findIndex(
    item => item.fileName === fileName
  )
  if (existingIndex > -1) {
    const status = undefined // ÂßãÁªà‰ΩøÁî®ÂêàÊ≥ïÁöÑÁ©∫Áä∂ÊÄÅ
    const progressText = percent === 100
      ? 'ÔºàÊúçÂä°Âô®Â§ÑÁêÜ‰∏≠...Ôºâ'
      : 'Ôºà‰∏ä‰º†‰∏≠...Ôºâ'
    threeDModelUploadProgress.value[existingIndex] = {
      ...threeDModelUploadProgress.value[existingIndex],
      progress: percent,
      status,
      progressText
    }
  }
}
// ‰∏ä‰º†Ë∂ÖËøáÈôêÂà∂Â§ÑÁêÜ
const handleExceed = (files, fileList) => {
  ElMessage.warning(`ÊØèÊ¨°ÊúÄÂ§ö‰∏ä‰º† ${props.limit} ‰∏™Êñá‰ª∂`)
}

// ‰∏ä‰º†ÊàêÂäüÂ§ÑÁêÜ
const handleUploadSuccess = (res, file, type) => {
  // ‰ºòÂÖàÂ§ÑÁêÜSHPÔºàredLineCoordinateÔºâÁ±ªÂûãÁöÑÈ™åËØÅÈÄªËæë
  if (type === 'redLineCoordinate') {
    try {
      const validationResult = res.data?.validationResult || {}
      dialogTitle.value = validationResult.message || 'SHPÊï∞ÊçÆÈ™åËØÅÁªìÊûú'
      dialogErrors.value = validationResult.fieldErrors || []
      dialogVisible.value = true
      // Âè™ÊúâÈ™åËØÅÈÄöËøáÔºàÊó†ÈîôËØØÔºâ‰∏îÂêéÁ´ØËøîÂõû‰∫ÜËµÑÊ∫ê‰ø°ÊÅØÔºåÊâçÊ∑ªÂä†Âà∞Êñá‰ª∂ÂàóË°®
      if (res.code === 200 && dialogErrors.value.length === 0) {
        const fileItem = {
          // ÂÖúÂ∫ïÔºöÂêéÁ´ØÊú™ËøîÂõûfileNameÊó∂Áî®ÂâçÁ´Ø‰∏ä‰º†ÁöÑÊñá‰ª∂Âêç
          name: res.data.fileName || file.name,
          url: res.data.url || '',
          ossId: res.data.ossId || ''
        }
        redLineCoordinateFileList.value.push(fileItem)
        ElMessage.success('SHPÊñá‰ª∂‰∏ä‰º†Âπ∂È™åËØÅÈÄöËøá')
      } else {
        // È™åËØÅÂ§±Ë¥•Ôºö‰∏çÊ∑ªÂä†Âà∞Êñá‰ª∂ÂàóË°®Ôºå‰ªÖÊèêÁ§∫
        ElMessage.warning('SHPÊï∞ÊçÆÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑Êü•ÁúãÂºπÁ™óËØ¶ÊÉÖ')
      }
    } catch (err) { // ÊçïËé∑Ëß£ÊûêÈîôËØØ
      console.error('redLineCoordinate‰∏ä‰º†Ëß£ÊûêÂ§±Ë¥•Ôºö', err);
      ElMessage.error('SHPÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•Ôºö' + err.message);
      dialogTitle.value = 'Ëß£ÊûêÂ§±Ë¥•';
      dialogErrors.value = [{ fieldName: 'redLineCoordinate', errorMessage: err.message }];
      dialogVisible.value = true;
    }
    return // ÁªàÊ≠¢ÂêéÁª≠ÈÄöÁî®ÈÄªËæë
  }
  // ÈÄöÁî®‰∏ä‰º†ÊàêÂäüÈÄªËæëÔºàÂÖ∂‰ªñÊñá‰ª∂Á±ªÂûãÔºâ
  if (res.code === 200) {
    console.log("üöÄ ~ handleUploadSuccess ~ res:", res)
    const fileItem = {
      name: res.data.fileName,
      url: res.data.url,
      ossId: res.data.ossId
    }
    // Ê∑ªÂä†Âà∞ÂØπÂ∫îÊñá‰ª∂ÂàóË°®
    switch (type) {
      case 'locationPlan': locationPlanFileList.value.push(fileItem); break
      case 'expertOpinions': expertOpinionsFileList.value.push(fileItem); break
      case 'meetingMaterials': meetingMaterialsFileList.value.push(fileItem); break;
      case 'siteSelectionReport': siteSelectionReportFileList.value.push(fileItem); break
      case 'approvalDocuments': approvalDocumentsFileList.value.push(fileItem); break
      case 'projectRedLine': projectRedLineFileList.value.push(fileItem); break
      case 'redLineCoordinate': redLineCoordinateFileList.value.push(fileItem); break
      case 'threeDModel':
        threeDModelFileList.value.push(fileItem);
        form.threeDModel = res.data.url;
        // Êõ¥Êñ∞ËøõÂ∫¶Êù°Áä∂ÊÄÅ‰∏∫ÊàêÂäü
        const fileName = getFileName(file.name)
        const progressIndex = threeDModelUploadProgress.value.findIndex(
          item => item.fileName === fileName || item.fileObj === file
        )
        if (progressIndex > -1) {
          threeDModelUploadProgress.value[progressIndex] = {
            fileName,
            progress: 100,
            status: 'success',
            fileId: res.data.ossId,
            fileObj: null, // ÈáäÊîæÊñá‰ª∂ÂØπË±°ÂºïÁî®
            progressText: '' // Ê∏ÖÁ©∫ÊèêÁ§∫ÊñáÊú¨
          }
        }
        break
    }
    ElMessage.success('‰∏ä‰º†ÊàêÂäü')
    if (basicFormRef.value) basicFormRef.value.validateField(type);
    if (infoFormRef.value) infoFormRef.value.validateField(type);
  } else {
    if (type === 'threeDModel') {
      const fileName = getFileName(file.name)
      const progressIndex = threeDModelUploadProgress.value.findIndex(
        item => item.fileName === fileName || item.fileObj === file
      )
      if (progressIndex > -1) {
        threeDModelUploadProgress.value[progressIndex] = {
          ...threeDModelUploadProgress.value[progressIndex],
          status: 'exception',
          fileObj: null,
          progressText: '' // Ê∏ÖÁ©∫ÊèêÁ§∫ÊñáÊú¨
        }
      }
    }
    ElMessage.error(res.msg || '‰∏ä‰º†Â§±Ë¥•')
  }
}

// Âà†Èô§‰∏ä‰º†Êñá‰ª∂Ôºà‰øÆÂ§çÔºö‰ΩøÁî® ossId ËÄåÈùû idÔºâ
const handleDeleteUploadFile = async (index, type) => {
  let fileList = []
  let fileId = ''
  let fileName = ''
  // Á°ÆÂÆöÂΩìÂâçÊìç‰ΩúÁöÑÊñá‰ª∂ÂàóË°®ÂíåÊñá‰ª∂ID
  switch (type) {
    case 'locationPlan':
      fileList = locationPlanFileList.value;
      fileId = fileList[index]?.ossId;
      break
    case 'expertOpinions':
      fileList = expertOpinionsFileList.value;
      fileId = fileList[index]?.ossId;
      break
    case 'meetingMaterials':
      fileList = meetingMaterialsFileList.value;
      fileId = fileList[index]?.ossId;
      break
    case 'siteSelectionReport':
      fileList = siteSelectionReportFileList.value;
      fileId = fileList[index]?.ossId;
      break
    case 'approvalDocuments':
      fileList = approvalDocumentsFileList.value;
      fileId = fileList[index]?.ossId;
      break
    case 'projectRedLine':
      fileList = projectRedLineFileList.value;
      fileId = fileList[index]?.ossId;
      break
    case 'redLineCoordinate':
      fileList = redLineCoordinateFileList.value;
      fileId = fileList[index]?.ossId;
      break
    case 'threeDModel':
      fileList = threeDModelFileList.value;
      fileId = fileList[index]?.ossId;
      fileName = getFileName(fileList[index].name);
      // ÁßªÈô§ÂØπÂ∫îÁöÑËøõÂ∫¶Êù°ÔºàÂ§öÈáçÂåπÈÖçÁ°Æ‰øùÂáÜÁ°ÆÔºâ
      const progressIndex = threeDModelUploadProgress.value.findIndex(
        item => item.fileId === fileId || item.fileName === fileName
      )
      if (progressIndex > -1) {
        threeDModelUploadProgress.value.splice(progressIndex, 1)
      }
      break
  }
  if (fileList.length > index) {
    fileList.splice(index, 1);
  }
  if (fileId) {
    try {
      await delOss(fileId)
      ElMessage.success('Êñá‰ª∂Âà†Èô§ÊàêÂäü')
    } catch (err) {
      ElMessage.warning('Êñá‰ª∂Âà†Èô§ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂèØËÉΩÈúÄË¶ÅÊâãÂä®Ê∏ÖÁêÜ')
    }
  }

  // Êõ¥Êñ∞‰∏âÁª¥Ê®°ÂûãURL
  if (type === 'threeDModel' && threeDModelFileList.value.length === 0) {
    form.threeDModel = ''
  }
  if (basicFormRef.value) basicFormRef.value.validateField(type);
  if (infoFormRef.value) infoFormRef.value.validateField(type);
}

// Êñá‰ª∂Âà†Èô§Êó∂Ëß¶ÂèëÊ†°È™åÔºàÁî®‰∫éElUploadÁöÑon-remove‰∫ã‰ª∂Ôºâ
const handleFileRemove = (type) => {
  basicFormRef.value?.validateField(type)
  infoFormRef.value?.validateField(type)
}
const handleDownloadTemplate = (type) => {
  try {
    // 1. ÂÆö‰πâÊ®°ÊùøÊñá‰ª∂Êò†Â∞ÑÔºötype -> { fileName: ‰∏ãËΩΩÂêéÁöÑÊñá‰ª∂Âêç, filePath: assetsÂÜÖÁöÑË∑ØÂæÑ }
    const templateMap = {
      instructions: {
        fileName: 'È£éÊôØÂêçËÉúÂå∫Ë¥®Ê£ÄÊï∞ÊçÆÂ°´ÂÜôËßÑÂàô.xlsx',
        filePath: '/È£éÊôØÂêçËÉúÂå∫Ë¥®Ê£ÄÊï∞ÊçÆÂ°´ÂÜôËßÑÂàô.xlsx' // ËØ∑Ê†πÊçÆÂÆûÈôÖÊñá‰ª∂Ë∑ØÂæÑË∞ÉÊï¥
      },
      polylineTemplate: {
        fileName: 'Á∫øÊ®°Êùø.zip',
        filePath: '/Á∫øÊ®°Êùø.zip' // ËØ∑Ê†πÊçÆÂÆûÈôÖÊñá‰ª∂Ë∑ØÂæÑË∞ÉÊï¥
      },
      polygonTemplate: {
        fileName: 'Èù¢Ê®°Êùø.zip',
        filePath: '/Èù¢Ê®°Êùø.zip' // ËØ∑Ê†πÊçÆÂÆûÈôÖÊñá‰ª∂Ë∑ØÂæÑË∞ÉÊï¥
      },
      threeD: {
        fileName: 'ÊñπÂ≤©ÊôØÂå∫Ê®°ÂûãÂà∂‰ΩúÊ†áÂáÜÂíåÊ°à‰æãÂèÇËÄÉ.doc',
        filePath: '/ÊñπÂ≤©ÊôØÂå∫Ê®°ÂûãÂà∂‰ΩúÊ†áÂáÜÂíåÊ°à‰æãÂèÇËÄÉ.doc' // ËØ∑Ê†πÊçÆÂÆûÈôÖÊñá‰ª∂Ë∑ØÂæÑË∞ÉÊï¥
      }
    };

    // 2. Ê†°È™åÊ®°ÊùøÁ±ªÂûã
    const template = templateMap[type];
    if (!template) {
      ElMessage.warning('Êó†ÊïàÁöÑÊ®°ÊùøÁ±ªÂûã');
      return;
    }

    // 3. Vite‰∏≠Ëé∑ÂèñassetsÊñá‰ª∂ÁöÑÊ≠£Á°ÆURLÔºàÂÖ≥ÈîÆÔºöÂÖºÂÆπÂºÄÂèë/Áîü‰∫ßÁéØÂ¢ÉÔºâ
    const fileUrl = new URL(template.filePath, import.meta.url).href;

    // 4. ÂàõÂª∫‰∏¥Êó∂aÊ†áÁ≠æËß¶Âèë‰∏ãËΩΩ
    const link = document.createElement('a');
    link.href = fileUrl;
    link.download = template.fileName; // ËÆæÁΩÆ‰∏ãËΩΩÂêéÁöÑÊñá‰ª∂Âêç
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click(); // Ëß¶ÂèëÁÇπÂáª‰∏ãËΩΩ

    // 5. Ê∏ÖÁêÜ‰∏¥Êó∂Ê†áÁ≠æ
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href); // ÈáäÊîæURLÂØπË±°
    ElMessage.success(`„Äå${template.fileName}„Äç‰∏ãËΩΩÊàêÂäü`);
  } catch (err) {
    ElMessage.error('Ê®°Êùø‰∏ãËΩΩÂ§±Ë¥•Ôºö' + (err.message || 'Êú™Áü•ÈîôËØØ'));
    console.error('‰∏ãËΩΩÊ®°ÊùøÂºÇÂ∏∏Ôºö', err);
  }
};
// ‰∏ãËΩΩÊ®°Êùø
// const handleDownloadTemplate = (type) => {
//   if (!proxy?.$download) {
//     ElMessage.error('‰∏ãËΩΩÂäüËÉΩÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
//     return;
//   }
//   try {
//     let ossId = '';
//     switch (type) {
//       case 'instructions': ossId = '1987829892356124674'; break;
//       case 'polylineTemplate': ossId = '1987829924379635713'; break;
//       case 'polygonTemplate': ossId = '1987829950501761026'; break;
//       case 'threeD': ossId = '1987830717459607554'; break;
//       default: ElMessage.warning('Êó†ÊïàÁöÑÊ®°ÊùøÁ±ªÂûã'); return;
//     }
//     proxy.$download.oss(ossId);
//   } catch (err) {
//     ElMessage.error('Ê®°Êùø‰∏ãËΩΩÂ§±Ë¥•Ôºö' + (err.message || 'Êú™Áü•ÈîôËØØ'));
//   }
// };
// ËøîÂõûÂàóË°®
const handleBackToList = () => {
  router.push('/project/normal')
}

// Êü•ÁúãËØ¶ÊÉÖ
const handleViewDetail = () => {
  router.push(`/project/normal/normal-view/${form.id}`);
}

// ÂèñÊ∂à
const cancel = () => {
  router.push('/project/normal')
}

// ÈáçÁΩÆ
const resetForm = async () => {
  try {
    const response = await getInfo(form.id)
    const projectData = response.data
    Object.assign(form, projectData)
    // ========== ÈáçÁΩÆÂ§öÈÄâÂ≠óÊÆµ‰∏∫Êï∞ÁªÑÊ†ºÂºè ==========
    form.protectionLevel = projectData.protectionLevel
      ? (Array.isArray(projectData.protectionLevel)
        ? projectData.protectionLevel
        : projectData.protectionLevel.split(',').filter(Boolean)
      )
      : []
    form.projectType = projectData.projectType
      ? (Array.isArray(projectData.projectType)
        ? projectData.projectType
        : projectData.projectType.split(',').filter(Boolean)
      )
      : []
    // ÈáçÁΩÆÊñá‰ª∂ÂàóË°®
    locationPlanFileList.value = projectData.locationPlan ? JSON.parse(projectData.locationPlan) : []
    expertOpinionsFileList.value = projectData.expertOpinions ? JSON.parse(projectData.expertOpinions) : []
    meetingMaterialsFileList.value = projectData.meetingMaterials ? JSON.parse(projectData.meetingMaterials) : []
    siteSelectionReportFileList.value = projectData.siteSelectionReport ? JSON.parse(projectData.siteSelectionReport) : []
    approvalDocumentsFileList.value = projectData.approvalDocuments ? JSON.parse(projectData.approvalDocuments) : []
    projectRedLineFileList.value = projectData.projectRedLine ? JSON.parse(projectData.projectRedLine) : []
    redLineCoordinateFileList.value = projectData.redLineCoordinate ? JSON.parse(projectData.redLineCoordinate) : []
    threeDModelFileList.value = projectData.threeDModel ? JSON.parse(projectData.threeDModel) : []
    // ÈáçÁΩÆ‰∏âÁª¥Ê®°ÂûãURL
    form.threeDModel = threeDModelFileList.value.length > 0 ? threeDModelFileList.value[0].url : ''
    threeDModelUploadProgress.value = threeDModelFileList.value.map(file => ({
      fileName: getFileName(file.name),
      progress: 100,
      status: 'success',
      fileId: file.ossId,
      progressText: ''
    }))
    basicFormRef.value?.clearValidate()
    infoFormRef.value?.clearValidate()
    ElMessage.success('Â∑≤ÈáçÁΩÆ‰∏∫ÂéüÂßãÊï∞ÊçÆ')
  } catch (err) {
    ElMessage.error('ÈáçÁΩÆÂ§±Ë¥•Ôºö' + (err.message || 'Êú™Áü•ÈîôËØØ'))
  }
}

/** ÊöÇÂ≠òÊåâÈíÆ */
const temporarilyForm = async () => {
  const submitData = {
    ...form,
    protectionLevel: form.protectionLevel.join(','),
    projectType: form.projectType.join(','),
    locationPlan: JSON.stringify(locationPlanFileList.value),
    expertOpinions: JSON.stringify(expertOpinionsFileList.value),
    meetingMaterials: JSON.stringify(meetingMaterialsFileList.value),
    siteSelectionReport: JSON.stringify(siteSelectionReportFileList.value),
    approvalDocuments: JSON.stringify(approvalDocumentsFileList.value),
    projectRedLine: JSON.stringify(projectRedLineFileList.value),
    redLineCoordinate: JSON.stringify(redLineCoordinateFileList.value),
    threeDModel: JSON.stringify(threeDModelFileList.value),
  }
  await stageInfo(submitData)
  proxy?.$modal.msgSuccess("ÊöÇÂ≠òÊàêÂäü")
  isTemporarilySaved.value = true
}
/** Êèê‰∫§ÊåâÈíÆÔºàÊ†∏ÂøÉÔºöÂÖàÊ†°È™åÔºåÂêéÊé•Âè£Ôºâ */
const submitForm = () => {
  basicFormRef.value.validate(async (basicValid) => {
    if (!basicValid) {
      ElMessage.warning('Âü∫Á°Ä‰ø°ÊÅØÂ°´ÂÜô‰∏çÁ¨¶ÂêàË¶ÅÊ±ÇÔºåËØ∑Ê£ÄÊü•');
      return;
    }
    infoFormRef.value.validate(async (valid) => {
      if (valid) {
        buttonLoading.value = true
        try {
          const submitData = {
            ...form,
            protectionLevel: form.protectionLevel.join(','),
            projectType: form.projectType.join(','),
            locationPlan: JSON.stringify(locationPlanFileList.value),
            expertOpinions: JSON.stringify(expertOpinionsFileList.value),
            meetingMaterials: JSON.stringify(meetingMaterialsFileList.value),
            siteSelectionReport: JSON.stringify(siteSelectionReportFileList.value),
            approvalDocuments: JSON.stringify(approvalDocumentsFileList.value),
            projectRedLine: JSON.stringify(projectRedLineFileList.value),
            redLineCoordinate: JSON.stringify(redLineCoordinateFileList.value),
            threeDModel: JSON.stringify(threeDModelFileList.value),
          }
          await submitInfo(submitData)
          ElMessage.success('Áî≥Êä•‰ø°ÊÅØÊèê‰∫§ÊàêÂäüÔºÅ');
          declartionInformation.value = false
        } catch (err) {
          proxy?.$modal.msgError("Êèê‰∫§Â§±Ë¥•Ôºö" + (err).message || "Êú™Áü•ÈîôËØØ")
        } finally {
          buttonLoading.value = false
        }
      } else {
        ElMessage.warning('Âª∫ËÆæ‰ø°ÊÅØÂ°´ÂÜô‰∏çÁ¨¶ÂêàË¶ÅÊ±ÇÔºåËØ∑Ê£ÄÊü•')
      }
    })
  })
}
// ‰∏âÁª¥Ê®°ÂûãÈ¢ÑËßà
const handleModelPreview = () => {
  if (threeDModelFileList.value.length === 0) {
    ElMessage.warning('ËØ∑ÂÖà‰∏ä‰º†‰∏âÁª¥Ê®°ÂûãÊñá‰ª∂')
    return
  }
  // 2. Ê†°È™åÊ®°ÂûãÂùêÊ†áÊòØÂê¶Â°´ÂÜô‰∏îÊ†ºÂºèÊ≠£Á°Æ
  if (!form.modelCoordinate) {
    ElMessage.warning('ËØ∑ËæìÂÖ•Ê®°ÂûãÂùêÊ†á')
    return
  }
  // Â§çÁî® rules ‰∏≠ÁöÑÂùêÊ†áÊ†ºÂºèÊ≠£ÂàôÔºàÈÅøÂÖçÈáçÂ§çÂÜôÊ≠£ÂàôÔºâ
  const coordinateReg = /^-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?$/
  if (!coordinateReg.test(form.modelCoordinate)) {
    ElMessage.warning('Ê®°ÂûãÂùêÊ†áÊ†ºÂºèÈîôËØØÔºåËØ∑ËæìÂÖ•ÔºöÁªèÂ∫¶,Á∫¨Â∫¶,È´òÂ∫¶,ÊóãËΩ¨ÊñπÂêëÔºàÊîØÊåÅÊ≠£Ë¥üÂ∞èÊï∞Ôºâ')
    return
  }
  // 3. Ê†°È™åÊòØÂê¶Â∑≤ÊöÇÂ≠ò
  if (!isTemporarilySaved.value) {
    ElMessage.warning('ËØ∑ÂÖàÁÇπÂáª„ÄåÊöÇÂ≠ò„ÄçÊåâÈíÆ‰øùÂ≠òÊï∞ÊçÆÂêéÔºåÂÜçËøõË°åÈ¢ÑËßà')
    return
  }
  const isProcessing = threeDModelUploadProgress.value.some(item =>
    item.progress < 100 || (item.progressText?.includes('ÊúçÂä°Âô®Â§ÑÁêÜ‰∏≠') ?? false)
  )
  if (isProcessing) {
    ElMessage.warning('Ê®°ÂûãÊñá‰ª∂Ê≠£Âú®‰∏ä‰º†ÊàñÂ§ÑÁêÜ‰∏≠ÔºåËØ∑Á≠âÂæÖÂÆåÊàêÂêéÂÜçÈ¢ÑËßà')
    return
  }
  // ÊâÄÊúâÊ†°È™åÈÄöËøáÔºåË∑≥ËΩ¨È¢ÑËßàÈ°µÈù¢
  router.push({
    path: '/screen/preview',
    query: {
      id: form.id,
      type: 'normal-edit'
    }
  })
}

</script>

<style scoped>
.add-content-container {
  width: 100%;
  padding: 20px;
  background-color: #f6f6f6;
  box-sizing: border-box;
  position: relative;
  min-height: 91vh;
}

.add-content {
  width: 100%;
  max-height: calc(100vh - 60px);
  overflow-y: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.add-content::-webkit-scrollbar {
  display: none;
}

.popup-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 27px;
  background-color: white;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  height: 96%;
  width: 97%;
  position: absolute;
}

.success-icon {
  width: 80px;
  height: 80px;
}

.success-text {
  font-size: 24px;
  color: #333;
  text-align: center;
}

.button-group {
  display: flex;
  gap: 20px;
  margin-top: 10px;
}

.btn-back {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 8px 24px;
}

.btn-view {
  background-color: white;
  color: #333;
  border: 1px solid #ddd;
  padding: 8px 24px;
}



.back-normal {
  width: 110px;
  height: 30px;
  font-size: 20px;
  display: flex;
  align-items: center;
  cursor: pointer;
}

.back-normal img {
  margin-right: 5px;
}

.add-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  background-color: #f6f6f6;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
  text-align: right;
  box-sizing: border-box;
  z-index: 10;
}

.project-basic-info,
.project-documents {
  background-color: #ffffff;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.section-title {
  font-size: 19px;
  font-weight: bold;
  color: #1f2329;
  padding-left: 5px;
  border-left: 3px solid #409eff;
}

.modelPreview {
  display: flex;
  align-items: center;
}

.modelPreview .imgModel {
  width: 20px;
  height: 20px;
  margin-right: 5px;
  vertical-align: middle;
}

.add-footer el-button+el-button {
  margin-left: 10px;
}

.operation-group {
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
  margin: 0;
  /* ÂéªÊéâÂéüÊúâ‰∏ä‰∏ãËæπË∑ù */
}

.operation-group div {
  color: #666;
  font-size: 14px;
}

.upload-progress-container {
  width: 50%;
  display: flex;
  gap: 6px;
}

.progress-file-name {
  font-size: 14px;
  color: #666;
  width: 70%;
}

.progress-text {
  font-size: 12px;
  color: #999;
  width: 70%;
}

.upload-progress-bar {
  width: 100% !important;
  --el-progress-text-color: #666;
  --el-progress-success-color: #67c23a;
  --el-progress-exception-color: #f56c6c;
}

:deep(.el-progress-bar) {
  width: 100% !important;
}

:deep(.el-progress__text) {
  flex: none !important;
  width: auto !important;
  margin-left: 8px !important;
}

.upload-container {
  display: flex;
  flex-direction: row;
  /* Êîπ‰∏∫Ê®™ÂêëÊéíÂàó */
  gap: 10px;
  /* ‰∏ä‰º†ÊåâÈíÆ‰∏éÊìç‰ΩúÁªÑÈó¥Ë∑ù */
  align-items: center;
  /* ÂûÇÁõ¥Â±Ö‰∏≠ÂØπÈΩê */
  width: 100%;
  flex-wrap: wrap;
  /* Ëá™ÈÄÇÂ∫îÊç¢Ë°å */
}

.upload-file-uploader {
  display: inline-block;
  width: auto;
  text-align: left !important;
}

.upload-file-list {
  width: 100%;
  box-sizing: border-box;
  padding-left: 0;
  margin: 0;
  list-style: none;
}

.ele-upload-list__item-content {
  display: flex;
  align-items: center;
  border: none;
  /* ÁßªÈô§ËæπÊ°Ü */
  border-radius: 0;
  /* ÂéªÊéâÂúÜËßí */
  width: 100%;
  box-sizing: border-box;
  padding: 0;
  /* ÂéªÊéâÂÜÖËæπË∑ù */
  margin-bottom: 8px;
  /* ‰ªÖ‰øùÁïô‰∏ä‰∏ãÊñá‰ª∂È°πÈó¥Ë∑ù */
  gap: 10px;
  /* Êñá‰ª∂Âêç‰∏éÂà†Èô§ÊåâÈíÆÈó¥Ë∑ù */
}

.ele-upload-list__item-content .el-link {
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding-right: 0;
  /* ÂéªÊéâÂè≥‰æßÂÜÖËæπË∑ù */
  font-size: 14px;
  /* Áªü‰∏ÄÂ≠ó‰ΩìÂ§ßÂ∞è */
}

.ele-upload-list__item-content .el-icon-document {
  margin-right: 5px;
  vertical-align: middle;
}

.ele-upload-list__item-content-action {
  flex-shrink: 0;
  width: auto;
  text-align: right;
}

.ele-upload-list__item-content-action .el-button {
  padding: 0 5px;
  min-width: auto;
  white-space: nowrap;
  font-size: 14px;
}

/* ========== Êñ∞Â¢ûÔºöSHPÈ™åËØÅÂºπÁ™óÊ†∑Âºè ========== */
.validation-dialog {
  --el-dialog-width: 800px !important;
}

/* ÂºπÁ™ó‰∏ª‰ΩìÈ´òÂ∫¶ÊéßÂà∂ÔºàÊÄªÈ´ò600px = Ê†áÈ¢òÊ†è~100px + ÂÜÖÂÆπÂå∫500pxÔºâ */
.validation-dialog :deep(.el-dialog__body) {
  height: 500px;
  padding: 24px;
  overflow-y: auto;
  /* ÈîôËØØÂ§öÁöÑÊó∂ÂÄôÊªöÂä® */
  box-sizing: border-box;
}

.validation-content {
  width: 100%;
  height: 100%;
}

.success-tip {
  font-size: 16px;
  color: #67c23a;
  text-align: center;
  margin-top: 40px;
}

.error-list {
  width: 100%;
}

.error-item {
  font-size: 14px;
  color: #f56c6c;
  margin-bottom: 12px;
  padding: 12px 16px;
  background-color: #fef0f0;
  border-radius: 4px;
  border-left: 4px solid #f56c6c;
}

.error-item .field-name {
  font-weight: bold;
  color: #e64942;
}

/* ========================================== */
</style>
