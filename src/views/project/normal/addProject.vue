<template>
  <div class="add-content-container">
    <div class="add-content">
      <div class="back-normal" @click="cancel"><img src="../../../assets/images/arrow-left.png" />åˆ›å»ºé¡¹ç›®</div>
      <!-- é¡¹ç›®åŸºç¡€ä¿¡æ¯ -->
      <div class="project-basic-info">
        <h3 class="section-title">é¡¹ç›®åŸºç¡€ä¿¡æ¯</h3>
        <el-form ref="infoFormRef" :model="form" label-width="230px" :rules="rules">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="å»ºè®¾æ´»åŠ¨ï¼ˆå»ºè®¾é¡¹ç›®ï¼‰åç§°" prop="projectName">
                <el-input v-model="form.projectName" placeholder="è¯·è¾“å…¥å»ºè®¾é¡¹ç›®åç§°" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="é¡¹ç›®ä»£ç " prop="projectCode">
                <el-input v-model="form.projectCode" placeholder="è¯·è¾“å…¥é¡¹ç›®ä»£ç " />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="æ‰€å±è¡Œæ”¿åŒºåˆ’" prop="administrativeRegion">
                <el-input v-model="form.administrativeRegion" placeholder="è¯·è¾“å…¥æ‰€å±è¡Œæ”¿åŒºåˆ’" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="æ¶‰åŠé£æ™¯åèƒœåŒºåç§°" prop="scenicArea">
                <el-input v-model="form.scenicArea" placeholder="è¯·è¾“å…¥æ¶‰åŠé£æ™¯åèƒœåŒºåç§°" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="å•ä½å»ºè®¾/ä¸ªäººå»ºè®¾" prop="applicantType">
                <el-radio-group v-model="form.applicantType">
                  <el-radio label="å•ä½">å•ä½</el-radio>
                  <el-radio label="ä¸ªäºº">ä¸ªäºº</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ä¸€èˆ¬/é‡ç‚¹é¡¹ç›®" prop="majorFlag">
                <el-radio-group v-model="form.majorFlag" disabled>
                  <el-radio :label="false">ä¸€èˆ¬é¡¹ç›®</el-radio>
                  <el-radio :label="true">é‡å¤§é¡¹ç›®</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>

      <!-- å»ºè®¾ä¿¡æ¯ -->
      <div class="project-documents">
        <div class="section-header">
          <h3 class="section-title">å»ºè®¾ä¿¡æ¯</h3>
          <el-button type="primary" @click="handleModelPreview" class="modelPreview">
            <img class="imgModel" src="../../../assets/images/model.png" />ä¸‰ç»´åœºæ™¯æ•ˆæœé¢„è§ˆ
          </el-button>
        </div>
        <el-form :model="form" label-width="230px">
          <!-- å»ºè®¾ä¿¡æ¯è¡¨å•å†…å®¹ -->
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="å»ºè®¾å•ä½åç§°" prop="constructionUnit">
                <el-input v-model="form.constructionUnit" placeholder="è¯·è¾“å…¥å»ºè®¾å•ä½åç§°" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ç»„ç»‡æœºæ„ä»£ç " prop="organizationCode">
                <el-input v-model="form.organizationCode" placeholder="è¯·è¾“å…¥ç»„ç»‡æœºæ„ä»£ç " />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ç»åŠäºº" prop="contactPerson">
                <el-input v-model="form.contactPerson" placeholder="è¯·è¾“å…¥ç»åŠäºº" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ç»åŠäººè”ç³»æ–¹å¼" prop="contactPhone">
                <el-input v-model="form.contactPhone" placeholder="è¯·è¾“å…¥ç»åŠäººè”ç³»æ–¹å¼" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ä¿æŠ¤åŒºç­‰çº§" prop="protectionLevel">
                <el-select v-model="form.protectionLevel" placeholder="è¯·é€‰æ‹©ä¿æŠ¤åŒºç­‰çº§">
                  <el-option label="ä¸€çº§ä¿æŠ¤åŒº" value="ä¸€çº§ä¿æŠ¤åŒº"></el-option>
                  <el-option label="äºŒçº§ä¿æŠ¤åŒº" value="äºŒçº§ä¿æŠ¤åŒº"></el-option>
                  <el-option label="ä¸‰çº§ä¿æŠ¤åŒºï¼ˆéæ ¸å¿ƒæ™¯åŒºï¼‰" value="ä¸‰çº§ä¿æŠ¤åŒºï¼ˆéæ ¸å¿ƒæ™¯åŒºï¼‰"></el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="é¡¹ç›®å ç”¨ç±»å‹" prop="projectType">
                <el-select v-model="form.projectType" placeholder="è¯·é€‰æ‹©é¡¹ç›®å ç”¨ç±»å‹">
                  <el-option label="é•¿æœŸ" value="é•¿æœŸ"></el-option>
                  <el-option label="ä¸´æ—¶" value="ä¸´æ—¶"></el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="é¡¹ç›®ç”¨é€”" prop="projectUsage">
                <el-input v-model="form.projectUsage" placeholder="è¯·è¾“å…¥é¡¹ç›®ç”¨é€”" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="æ‹Ÿé€‰ä½ç½®" prop="projectPurpose">
                <el-input v-model="form.projectPurpose" placeholder="è¯·è¾“å…¥æ‹Ÿé€‰ä½ç½®" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="å»ºè®¾é¡¹ç›®æ‹ŸæŠ•èµ„é¢ï¼ˆä¸‡å…ƒï¼‰" prop="projectInvestment">
            <el-input v-model="form.projectInvestment" placeholder="è¯·è¾“å…¥å»ºè®¾é¡¹ç›®æ€»æŠ•èµ„" />
          </el-form-item>
          <el-form-item label="è§„åˆ’ä¾æ®" prop="planningBasis">
            <el-input v-model="form.planningBasis" type="textarea" placeholder="è¯·è¾“å…¥è§„åˆ’ä¾æ®" />
          </el-form-item>
          <el-form-item label="å»ºè®¾å†…å®¹æ¶‰åŠè§„æ¨¡" prop="constructionContent">
            <el-input v-model="form.constructionContent" type="textarea" placeholder="è¯·è¾“å…¥å»ºè®¾å†…å®¹æ¶‰åŠè§„æ¨¡" />
          </el-form-item>
          <el-form-item label="å…¶ä»–éœ€è¦è¯´æ˜çš„æƒ…å†µ" prop="otherExplanations">
            <el-input v-model="form.otherExplanations" type="textarea" placeholder="è¯·è¾“å…¥å…¶ä»–éœ€è¦è¯´æ˜çš„æƒ…å†µ" />
          </el-form-item>

          <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="é€‰å€æ–¹æ¡ˆ" prop="locationPlan">
                <el-upload ref="locationPlanUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'locationPlan')" :file-list="locationPlanFileList"
                  :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'locationPlan')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'locationPlan')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in locationPlanFileList" :key="file.ossId"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'locationPlan')">
                        åˆ é™¤
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ä¸“å®¶è¯„å®¡æ„è§" prop="expertOpinions">
                <el-upload ref="expertOpinionsUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'expertOpinions')"
                  :file-list="expertOpinionsFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'expertOpinions')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'expertOpinions')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in expertOpinionsFileList" :key="file.ossId"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'expertOpinions')">
                        åˆ é™¤
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="å…¬ç¤ºææ–™" prop="meetingMaterials">
                <el-upload ref="meetingMaterialsUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'meetingMaterials')"
                  :file-list="meetingMaterialsFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'meetingMaterials')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'meetingMaterials')"
                  :show-file-list="false" :headers="headers" class="upload-file-uploader"
                  :disabled="props.compDisabled">
                  <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in meetingMaterialsFileList" :key="file.ossId"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'meetingMaterials')">
                        åˆ é™¤
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="é€‰å€æ–¹æ¡ˆæ ¸å‡†ç”³æŠ¥è¡¨" prop="siteSelectionReport">
                <el-upload ref="siteSelectionReportUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'siteSelectionReport')"
                  :file-list="siteSelectionReportFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'siteSelectionReport')"
                  :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'siteSelectionReport')"
                  :show-file-list="false" :headers="headers" class="upload-file-uploader"
                  :disabled="props.compDisabled">
                  <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in siteSelectionReportFileList" :key="file.ossId"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'siteSelectionReport')">
                        åˆ é™¤
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ç«‹é¡¹æ–‡ä»¶" prop="approvalDocuments">
                <el-upload ref="approvalDocumentsUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'approvalDocuments')"
                  :file-list="approvalDocumentsFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'approvalDocuments')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'approvalDocuments')"
                  :show-file-list="false" :headers="headers" class="upload-file-uploader"
                  :disabled="props.compDisabled">
                  <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in approvalDocumentsFileList" :key="file.ossId"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'approvalDocuments')">
                        åˆ é™¤
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="é¡¹ç›®ç”¨åœ°çº¢çº¿å›¾" prop="projectRedLine">
                <el-upload ref="projectRedLineUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'projectRedLine')"
                  :file-list="projectRedLineFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'projectRedLine')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'projectRedLine')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in projectRedLineFileList" :key="file.ossId"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'projectRedLine')">
                        åˆ é™¤
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="é¡¹ç›®çº¢çº¿çŸ¢é‡æ•°æ®" prop="redLineCoordinate">
            <el-upload ref="redLineCoordinateUploadRef" multiple :action="uploadFileUrl"
              :before-upload="(file) => handleBeforeUpload(file, 'redLineCoordinate')"
              :file-list="redLineCoordinateFileList" :limit="props.limit" :accept="getFileAccept()"
              :on-error="(err, file) => handleUploadError(err, file, 'redLineCoordinate')" :on-exceed="handleExceed"
              :on-success="(res, file) => handleUploadSuccess(res, file, 'redLineCoordinate')" :show-file-list="false"
              :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
              <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
            </el-upload>
            <div class="operation-group">
              <el-button link type="primary" @click="handleDownloadTemplate('instructions')">å¡«å†™è¯´æ˜</el-button>
              <el-button link type="primary" @click="handleDownloadTemplate('polygonTemplate')">é¢æ¨¡æ¿ä¸‹è½½</el-button>
              <el-button link type="primary" @click="handleDownloadTemplate('polylineTemplate')">çº¿æ¨¡æ¿ä¸‹è½½</el-button>
              <div>ï¼ˆä½¿ç”¨å‰ï¼Œè¯·åˆ é™¤æ¨¡æ¿ä¸­çš„å®ä¾‹æ•°æ®ï¼‰</div>
            </div>
            <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
              tag="ul">
              <li v-for="(file, index) in redLineCoordinateFileList" :key="file.ossId"
                class="el-upload-list__item ele-upload-list__item-content">
                <el-link :href="`${file.url}`" :underline="false" target="_blank">
                  <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                </el-link>
                <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                  <el-button type="danger" link @click="handleDeleteUploadFile(index, 'redLineCoordinate')">
                    åˆ é™¤
                  </el-button>
                </div>
              </li>
            </transition-group>
          </el-form-item>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="é¡¹ç›®ä¸‰ç»´æ¨¡å‹" prop="threeDModel">
                <el-upload ref="threeDModelUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'threeDModel')" :file-list="threeDModelFileList"
                  :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'threeDModel')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'threeDModel')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
                </el-upload>
                <div class="operation-group">
                  <el-button link type="primary" icon="Download"
                    @click="handleDownloadTemplate('threeD')">æ¨¡å‹è§„èŒƒä¸æ¨¡æ¿ä¸‹è½½</el-button>
                </div>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in threeDModelFileList" :key="file.ossId"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'threeDModel')">
                        åˆ é™¤
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="æ¨¡å‹åæ ‡" prop="modelCoordinate">
                <el-input v-model="form.modelCoordinate" placeholder="è¯·è¾“å…¥æ¨¡å‹åæ ‡æ ¼å¼ä¸ºï¼šç»åº¦,çº¬åº¦,é«˜åº¦,æ—‹è½¬æ–¹å‘" />
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </div>
    <div class="add-footer">
      <el-button @click="cancel">å–æ¶ˆ</el-button>
      <el-button type="warning" @click="resetForm">é‡ç½®</el-button>
      <el-button type="success" v-hasPermi="['project:project:stage']" @click="temporarilyForm">æš‚å­˜</el-button>
      <el-button :loading="buttonLoading" type="primary" @click="submitForm">ç¡®å®š</el-button>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, nextTick, getCurrentInstance } from 'vue'
import { useRouter } from 'vue-router'
import { stageInfo, addInfo } from '@/api/project/normal/index';
import { delOss, listByIds } from '@/api/system/oss';
import { getUserProfile } from '@/api/system/user/index';
import { useUserStore } from '@/store/modules/user'
import { propTypes } from '@/utils/propTypes';
import { globalHeaders } from '@/utils/request';
import { ElMessage } from 'element-plus'
const { proxy } = getCurrentInstance() || {}
const router = useRouter()
// åˆå§‹åŒ– Pinia å®ä¾‹
const userStore = useUserStore()
// å®šä¹‰ç»„ä»¶å±æ€§
const props = defineProps({
  // æ•°é‡é™åˆ¶
  limit: propTypes.number.def(15),
  // å¤§å°é™åˆ¶(MB)
  fileSize: propTypes.number.def(500),
  // æ–‡ä»¶ç±»å‹
  fileType: propTypes.array.def([
    'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'pdf', 'zip', 'rar',
    'dwg', 'dxf', 'jpg', 'jpeg', 'png', 'cpg', 'dbf', 'prj', 'sbn', 'sbx',
    'shp', 'shp.xml', 'shx', 'FBX', 'fbm', 'obj', 'pak'
  ]),

});

// è¡¨å•å¼•ç”¨
const infoFormRef = ref(null)
// æŒ‰é’®åŠ è½½çŠ¶æ€
const buttonLoading = ref(false)

// ç»„ä»¶çŠ¶æ€
const form = reactive({
  id: undefined,
  projectName: undefined,
  projectCode: undefined,
  administrativeRegion: undefined,
  scenicArea: undefined,
  applicantType: 'å•ä½', // é»˜è®¤å•ä½
  constructionUnit: undefined,
  organizationCode: undefined,
  contactPerson: undefined,
  contactPhone: undefined,
  protectionLevel: '',
  status: undefined,
  projectType: '',
  projectUsage: undefined,
  projectPurpose: undefined,
  createTime: undefined,
  updateTime: undefined,
  projectInvestment: undefined,
  planningBasis: undefined,
  constructionContent: undefined,
  otherExplanations: undefined,
  locationPlan: undefined,
  expertOpinions: undefined,
  meetingMaterials: undefined,
  siteSelectionReport: undefined,
  approvalDocuments: undefined,
  projectRedLine: undefined,
  redLineCoordinate: undefined,
  threeDModel: undefined,
  modelCoordinate: undefined,
  modelPreview: undefined,
  majorFlag: false,

})

// è¡¨å•éªŒè¯è§„åˆ™
const rules = reactive({
  projectName: [{ required: true, message: 'è¯·è¾“å…¥å»ºè®¾é¡¹ç›®åç§°', trigger: 'blur' }],
  administrativeRegion: [{ required: true, message: 'è¯·è¾“å…¥æ‰€å±è¡Œæ”¿åŒºåˆ’', trigger: 'blur' }],
  applicantType: [{ required: true, message: 'è¯·é€‰æ‹©å»ºè®¾ç±»å‹', trigger: 'change' }],
  constructionUnit: [{ required: true, message: 'è¯·è¾“å…¥å»ºè®¾å•ä½åç§°', trigger: 'blur' }],
  contactPerson: [{ required: true, message: 'è¯·è¾“å…¥ç»åŠäºº', trigger: 'blur' }],
  contactPhone: [{
    required: true,
    message: 'è¯·è¾“å…¥ç»åŠäººè”ç³»æ–¹å¼',
    trigger: 'blur'
  }, {
    pattern: /^1[3-9]\d{9}$/,
    message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ',
    trigger: 'blur'
  }]
})

// æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨
const locationPlanFileList = ref([])
const expertOpinionsFileList = ref([])
const meetingMaterialsFileList = ref([])
const siteSelectionReportFileList = ref([])
const approvalDocumentsFileList = ref([])
const projectRedLineFileList = ref([])
const redLineCoordinateFileList = ref([])
const threeDModelFileList = ref([])

// ä¸Šä¼ ç›¸å…³é…ç½®
const uploadFileUrl = import.meta.env.VITE_APP_BASE_API + '/resource/oss/upload'
const headers = ref(globalHeaders())

// è·å–æ–‡ä»¶æ¥å—ç±»å‹
const getFileAccept = () => {
  return props.fileType.map(type => `.${type.toLowerCase()}`).join(',')
}

// ç”Ÿå‘½å‘¨æœŸï¼šåˆå§‹åŒ–æ—¶ä» Store è¯»å–æ•°æ®
onMounted(() => {
  // å¦‚æœæ˜¯ä»é¢„è§ˆé¡µè¿”å›çš„ç¼–è¾‘çŠ¶æ€
})

// ä¸Šä¼ å‰ç½®æ ¡éªŒ
const handleBeforeUpload = (file, type) => {
  // éªŒè¯æ–‡ä»¶å¤§å°
  const isLtMaxSize = file.size / 1024 / 1024 < props.fileSize
  if (!isLtMaxSize) {
    ElMessage.error(`æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ ${props.fileSize}MB!`)
    return false
  }

  // éªŒè¯æ–‡ä»¶ç±»å‹
  const fileExt = file.name.split('.').pop()?.toLowerCase()
  if (!props.fileType.includes(fileExt)) {
    ElMessage.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼ ${props.fileType.join(',')}æ ¼å¼çš„æ–‡ä»¶`)
    return false
  }

  return true
}
const getFileName = (name) => {
  // å¤„ç†nameä¸ºnull/undefinedçš„æƒ…å†µ
  if (!name) return 'æœªçŸ¥æ–‡ä»¶å'
  // å¤„ç†è·¯å¾„åˆ†éš”ç¬¦ï¼ˆå…¼å®¹windowså’Œunixï¼‰
  const separatorIndex = Math.max(name.lastIndexOf('/'), name.lastIndexOf('\\'))
  return separatorIndex > -1 ? name.slice(separatorIndex + 1) : name
}
// ä¸Šä¼ é”™è¯¯å¤„ç†
const handleUploadError = (err, file, type) => {
  ElMessage.error(`ä¸Šä¼ å¤±è´¥: ${err.message || 'æœªçŸ¥é”™è¯¯'}`)
}

// ä¸Šä¼ è¶…è¿‡é™åˆ¶å¤„ç†
const handleExceed = (files, fileList) => {
  ElMessage.warning(`æ¯æ¬¡æœ€å¤šä¸Šä¼  ${props.limit} ä¸ªæ–‡ä»¶`)
}

// ä¸Šä¼ æˆåŠŸå¤„ç†
const handleUploadSuccess = (res, file, type) => {
  if (res.code === 200) {
    // æ ¹æ®ç±»å‹æ›´æ–°å¯¹åº”æ–‡ä»¶åˆ—è¡¨
    const fileItem = {
      name: res.data.fileName,
      url: res.data.url,
      ossId: res.data.ossId
    }

    switch (type) {
      case 'locationPlan':
        locationPlanFileList.value.push(fileItem)
        break
      case 'expertOpinions':
        expertOpinionsFileList.value.push(fileItem)
        break
      case 'meetingMaterials':
        meetingMaterialsFileList.value.push(fileItem)
        break
      case 'siteSelectionReport':
        siteSelectionReportFileList.value.push(fileItem)
        break
      case 'approvalDocuments':
        approvalDocumentsFileList.value.push(fileItem)
        break
      case 'projectRedLine':
        projectRedLineFileList.value.push(fileItem)
        break
      case 'redLineCoordinate':
        redLineCoordinateFileList.value.push(fileItem)
        break
      case 'threeDModel':
        threeDModelFileList.value.push(fileItem)
        form.threeDModel = res.url // ä¿å­˜ä¸‰ç»´æ¨¡å‹URL
        break
    }
    ElMessage.success('ä¸Šä¼ æˆåŠŸ')
  } else {
    ElMessage.error(res.msg || 'ä¸Šä¼ å¤±è´¥')
  }
}

// åˆ é™¤ä¸Šä¼ æ–‡ä»¶
const handleDeleteUploadFile = (index, type) => {
  switch (type) {
    case 'locationPlan':
      locationPlanFileList.value.splice(index, 1)
      break
    case 'expertOpinions':
      expertOpinionsFileList.value.splice(index, 1)
      break
    case 'meetingMaterials':
      meetingMaterialsFileList.value.splice(index, 1)
      break
    case 'siteSelectionReport':
      siteSelectionReportFileList.value.splice(index, 1)
      break
    case 'approvalDocuments':
      approvalDocumentsFileList.value.splice(index, 1)
      break
    case 'projectRedLine':
      projectRedLineFileList.value.splice(index, 1)
      break
    case 'redLineCoordinate':
      redLineCoordinateFileList.value.splice(index, 1)
      break
    case 'threeDModel':
      threeDModelFileList.value.splice(index, 1)
      if (threeDModelFileList.value.length === 0) {
        form.threeDModel = undefined
      }
      break
  }
}

// ä¸‹è½½æ¨¡æ¿
const handleDownloadTemplate = (type) => {
  console.log("ğŸš€ ~ handleDownloadTemplate ~ proxy:", proxy)
  if (type === 'instructions') {
    proxy?.$download.oss('1987829892356124674');
  } else if (type === 'polylineTemplate') {
    proxy?.$download.oss('1987829924379635713');
  } else if (type === 'polygonTemplate') {
    proxy?.$download.oss('1987829950501761026');
  } else if (type === 'threeD') {
    proxy?.$download.oss('1987830717459607554');
  }
}
/** å–æ¶ˆæŒ‰é’® */
const cancel = async () => {
  router.push('/project/normal')
}
/** é‡ç½®æŒ‰é’® */
const resetForm = () => {
  infoFormRef.value?.resetFields()
  // æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶åˆ—è¡¨
  locationPlanFileList.value = []
  expertOpinionsFileList.value = []
  meetingMaterialsFileList.value = []
  siteSelectionReportFileList.value = []
  approvalDocumentsFileList.value = []
  projectRedLineFileList.value = []
  redLineCoordinateFileList.value = []
  threeDModelFileList.value = []
  // é‡ç½®è¡¨å•å¯¹è±¡
  Object.keys(form).forEach(key => {
    if (key !== 'applicantType' && key !== 'majorFlag') {
      form[key] = undefined
    }
  })
}
/** æš‚å­˜æŒ‰é’® */
const temporarilyForm = async () => {
  // å‡†å¤‡æäº¤æ•°æ®ï¼ˆåŒ…å«æ–‡ä»¶ä¿¡æ¯ï¼‰
  const submitData = {
    ...form,
    // é™„åŠ æ–‡ä»¶åˆ—è¡¨
    locationPlan: JSON.stringify(locationPlanFileList.value),
    expertOpinions: JSON.stringify(expertOpinionsFileList.value),
    meetingMaterials: JSON.stringify(meetingMaterialsFileList.value),
    siteSelectionReport: JSON.stringify(siteSelectionReportFileList.value),
    approvalDocuments: JSON.stringify(approvalDocumentsFileList.value),
    projectRedLine: JSON.stringify(projectRedLineFileList.value),
    redLineCoordinate: JSON.stringify(redLineCoordinateFileList.value),
    threeDModel: JSON.stringify(threeDModelFileList.value),
  }
  await stageInfo(submitData)
  proxy?.$modal.msgSuccess("æš‚å­˜æˆåŠŸ")
}

/** æäº¤æŒ‰é’® */
const submitForm = () => {
  infoFormRef.value?.validate(async (valid) => {
    if (valid) {
      buttonLoading.value = true
      try {
        // å‡†å¤‡æäº¤æ•°æ®ï¼ˆåŒ…å«æ–‡ä»¶ä¿¡æ¯ï¼‰
        const submitData = {
          ...form,
          // é™„åŠ æ–‡ä»¶åˆ—è¡¨
          locationPlan: JSON.stringify(locationPlanFileList.value),
          expertOpinions: JSON.stringify(expertOpinionsFileList.value),
          meetingMaterials: JSON.stringify(meetingMaterialsFileList.value),
          siteSelectionReport: JSON.stringify(siteSelectionReportFileList.value),
          approvalDocuments: JSON.stringify(approvalDocumentsFileList.value),
          projectRedLine: JSON.stringify(projectRedLineFileList.value),
          redLineCoordinate: JSON.stringify(redLineCoordinateFileList.value),
          threeDModel: JSON.stringify(threeDModelFileList.value),
        }
        await addInfo(submitData)
        proxy?.$modal.msgSuccess("æäº¤æˆåŠŸ")
        // æäº¤æˆåŠŸåè¿”å›åˆ—è¡¨é¡µ
        router.push('/project/normal')
      } catch (err) {
        proxy?.$modal.msgError("æäº¤å¤±è´¥ï¼š" + (err).message || "æœªçŸ¥é”™è¯¯")
      } finally {
        buttonLoading.value = false
      }
    }
  })
}

// ä¸‰ç»´æ¨¡å‹é¢„è§ˆ
const handleModelPreview = () => {
  if (!form.threeDModel && threeDModelFileList.value.length === 0) {
    ElMessage.warning('è¯·å…ˆä¸Šä¼ ä¸‰ç»´æ¨¡å‹æ–‡ä»¶')
    return
  }
  if (!form.modelCoordinate) {
    ElMessage.warning('è¯·è¾“å…¥æ¨¡å‹åæ ‡')
    return
  }
  const coordinateReg = /^-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?$/
  if (!coordinateReg.test(form.modelCoordinate)) {
    ElMessage.warning('æ¨¡å‹åæ ‡æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥ï¼šç»åº¦,çº¬åº¦,é«˜åº¦,æ—‹è½¬æ–¹å‘ï¼ˆæ”¯æŒæ­£è´Ÿå°æ•°ï¼‰')
    return
  }
  if (!isTemporarilySaved.value) {
    ElMessage.warning('è¯·å…ˆç‚¹å‡»ã€Œæš‚å­˜ã€æŒ‰é’®ä¿å­˜æ•°æ®åï¼Œå†è¿›è¡Œé¢„è§ˆ')
    return
  }
  router.push({
    path: '/screen/preview',
    query: {
      id: form.id,
      type: 'normal-add'
    }
  })
}

</script>

<style scoped>
.add-content-container {
  width: 100%;
  padding: 20px;
  background-color: #f6f6f6;
  box-sizing: border-box;
  position: relative;
  min-height: 100vh;
  padding-bottom: 80px;
}

.add-content {
  width: 100%;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

.back-normal {
  width: 110px;
  height: 30px;
  font-size: 20px;
  display: flex;
  align-items: center;
  cursor: pointer;
}

.back-normal img {
  margin-right: 5px;
}

.add-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  background-color: #f6f6f6;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
  text-align: right;
  box-sizing: border-box;
  z-index: 10;
}

.project-basic-info,
.project-documents {
  background-color: #ffffff;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.section-title {
  font-size: 19px;
  font-weight: bold;
  color: #1f2329;
  padding-left: 5px;
  border-left: 3px solid #409eff;
}

.modelPreview {
  display: flex;
  align-items: center;

  .imgModel {
    width: 20px;
    height: 20px;
    margin-right: 5px;
    vertical-align: middle;
  }
}



.add-footer el-button+el-button {
  margin-left: 10px;
}

.upload-file-list {
  margin-top: 10px;
}

.ele-upload-list__item-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 10px;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
  margin-bottom: 5px;
}

.ele-upload-list__item-content-action {
  margin-left: 10px;
}

.operation-group {
  margin-top: 10px;
  margin-bottom: 15px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

.operation-group div {
  color: #666;
  font-size: 18px;
}
</style>
<style>
body {
  overflow: auto;
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}

body::-webkit-scrollbar {
  display: none !important;
  /* Chrome/Safari */
  width: 0 !important;
  height: 0 !important;
}

* {
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}

*::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
  height: 0 !important;
}
</style>