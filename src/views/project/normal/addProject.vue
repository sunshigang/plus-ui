<template>
  <div class="add-content-container">
    <div class="add-content">
      <!-- È°πÁõÆÂü∫Á°Ä‰ø°ÊÅØ -->
      <div class="project-basic-info">
        <h3 class="section-title">È°πÁõÆÂü∫Á°Ä‰ø°ÊÅØ</h3>
        <el-form ref="infoFormRef" :model="form" label-width="230px" :rules="rules">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Âª∫ËÆæÊ¥ªÂä®ÔºàÂª∫ËÆæÈ°πÁõÆÔºâÂêçÁß∞" prop="projectName">
                <el-input v-model="form.projectName" placeholder="ËØ∑ËæìÂÖ•Âª∫ËÆæÈ°πÁõÆÂêçÁß∞" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="È°πÁõÆ‰ª£Á†Å" prop="projectCode">
                <el-input v-model="form.projectCode" placeholder="ËØ∑ËæìÂÖ•È°πÁõÆ‰ª£Á†Å" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÊâÄÂ±ûË°åÊîøÂå∫Âàí" prop="administrativeRegion">
                <el-input v-model="form.administrativeRegion" placeholder="ËØ∑ËæìÂÖ•ÊâÄÂ±ûË°åÊîøÂå∫Âàí" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Ê∂âÂèäÈ£éÊôØÂêçËÉúÂå∫ÂêçÁß∞" prop="scenicArea">
                <el-input v-model="form.scenicArea" placeholder="ËØ∑ËæìÂÖ•Ê∂âÂèäÈ£éÊôØÂêçËÉúÂå∫ÂêçÁß∞" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Âçï‰ΩçÂª∫ËÆæ/‰∏™‰∫∫Âª∫ËÆæ" prop="applicantType">
                <el-radio-group v-model="form.applicantType">
                  <el-radio label="Âçï‰Ωç">Âçï‰Ωç</el-radio>
                  <el-radio label="‰∏™‰∫∫">‰∏™‰∫∫</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="‰∏ÄËà¨/ÈáçÁÇπÈ°πÁõÆ" prop="majorFlag">
                <el-radio-group v-model="form.majorFlag" disabled>
                  <el-radio :label="false">‰∏ÄËà¨È°πÁõÆ</el-radio>
                  <el-radio :label="true">ÈáçÂ§ßÈ°πÁõÆ</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>

      <!-- Âª∫ËÆæ‰ø°ÊÅØ -->
      <div class="project-documents">
        <div class="section-header">
          <h3 class="section-title">Âª∫ËÆæ‰ø°ÊÅØ</h3>
          <el-button type="primary" @click="handleModelPreview" class="modelPreview">
            <img class="imgModel" src="../../../assets/images/model.png" />‰∏âÁª¥Âú∫ÊôØÊïàÊûúÈ¢ÑËßà
          </el-button>
        </div>
        <el-form :model="form" label-width="230px">
          <!-- Âª∫ËÆæ‰ø°ÊÅØË°®ÂçïÂÜÖÂÆπ -->
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Âª∫ËÆæÂçï‰ΩçÂêçÁß∞" prop="constructionUnit">
                <el-input v-model="form.constructionUnit" placeholder="ËØ∑ËæìÂÖ•Âª∫ËÆæÂçï‰ΩçÂêçÁß∞" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÁªÑÁªáÊú∫ÊûÑ‰ª£Á†Å" prop="organizationCode">
                <el-input v-model="form.organizationCode" placeholder="ËØ∑ËæìÂÖ•ÁªÑÁªáÊú∫ÊûÑ‰ª£Á†Å" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÁªèÂäû‰∫∫" prop="contactPerson">
                <el-input v-model="form.contactPerson" placeholder="ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÁªèÂäû‰∫∫ËÅîÁ≥ªÊñπÂºè" prop="contactPhone">
                <el-input v-model="form.contactPhone" placeholder="ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫ËÅîÁ≥ªÊñπÂºè" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="‰øùÊä§Âå∫Á≠âÁ∫ß" prop="protectionLevel">
                <el-input v-model="form.protectionLevel" placeholder="ËØ∑ËæìÂÖ•‰øùÊä§Á≠âÁ∫ß" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="È°πÁõÆÂç†Áî®Á±ªÂûã" prop="projectType">
                <el-input v-model="form.projectType" placeholder="ËØ∑ËæìÂÖ•È°πÁõÆÂç†Áî®Á±ªÂûã" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="È°πÁõÆÁî®ÈÄî" prop="projectUsage">
                <el-input v-model="form.projectUsage" placeholder="ËØ∑ËæìÂÖ•È°πÁõÆÁî®ÈÄî" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÊãüÈÄâ‰ΩçÁΩÆ" prop="projectPurpose">
                <el-input v-model="form.projectPurpose" placeholder="ËØ∑ËæìÂÖ•ÊãüÈÄâ‰ΩçÁΩÆ" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="Âª∫ËÆæÈ°πÁõÆÊãüÊäïËµÑÈ¢ùÔºà‰∏áÂÖÉÔºâ" prop="projectInvestment">
            <el-input v-model="form.projectInvestment" placeholder="ËØ∑ËæìÂÖ•Âª∫ËÆæÈ°πÁõÆÊÄªÊäïËµÑ" />
          </el-form-item>
          <el-form-item label="ËßÑÂàí‰æùÊçÆ" prop="planningBasis">
            <el-input v-model="form.planningBasis" type="textarea" placeholder="ËØ∑ËæìÂÖ•ËßÑÂàí‰æùÊçÆ" />
          </el-form-item>
          <el-form-item label="Âª∫ËÆæÂÜÖÂÆπÊ∂âÂèäËßÑÊ®°" prop="constructionContent">
            <el-input v-model="form.constructionContent" type="textarea" placeholder="ËØ∑ËæìÂÖ•Âª∫ËÆæÂÜÖÂÆπÊ∂âÂèäËßÑÊ®°" />
          </el-form-item>
          <el-form-item label="ÂÖ∂‰ªñÈúÄË¶ÅËØ¥ÊòéÁöÑÊÉÖÂÜµ" prop="otherExplanations">
            <el-input v-model="form.otherExplanations" type="textarea" placeholder="ËØ∑ËæìÂÖ•ÂÖ∂‰ªñÈúÄË¶ÅËØ¥ÊòéÁöÑÊÉÖÂÜµ" />
          </el-form-item>

          <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÈÄâÂùÄÊñπÊ°à" prop="locationPlan">
                <el-upload ref="locationPlanUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'locationPlan')" :file-list="locationPlanFileList"
                  :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'locationPlan')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'locationPlan')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in locationPlanFileList" :key="file.uid"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'locationPlan')">
                        Âà†Èô§
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="‰∏ìÂÆ∂ËØÑÂÆ°ÊÑèËßÅ" prop="expertOpinions">
                <el-upload ref="expertOpinionsUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'expertOpinions')"
                  :file-list="expertOpinionsFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'expertOpinions')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'expertOpinions')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in expertOpinionsFileList" :key="file.uid"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'expertOpinions')">
                        Âà†Èô§
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÂÖ¨Á§∫ÊùêÊñô" prop="publicMaterial">
                <el-upload ref="publicMaterialUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'publicMaterial')"
                  :file-list="publicMaterialFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'publicMaterial')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'publicMaterial')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in publicMaterialFileList" :key="file.uid"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'publicMaterial')">
                        Âà†Èô§
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÈÄâÂùÄÊñπÊ°àÊ†∏ÂáÜÁî≥Êä•Ë°®" prop="siteSelectionReport">
                <el-upload ref="siteSelectionReportUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'siteSelectionReport')"
                  :file-list="siteSelectionReportFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'siteSelectionReport')"
                  :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'siteSelectionReport')"
                  :show-file-list="false" :headers="headers" class="upload-file-uploader"
                  :disabled="props.compDisabled">
                  <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in siteSelectionReportFileList" :key="file.uid"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'siteSelectionReport')">
                        Âà†Èô§
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Á´ãÈ°πÊñá‰ª∂" prop="approvalDocuments">
                <el-upload ref="approvalDocumentsUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'approvalDocuments')"
                  :file-list="approvalDocumentsFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'approvalDocuments')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'approvalDocuments')"
                  :show-file-list="false" :headers="headers" class="upload-file-uploader"
                  :disabled="props.compDisabled">
                  <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in approvalDocumentsFileList" :key="file.uid"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'approvalDocuments')">
                        Âà†Èô§
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="È°πÁõÆÁî®Âú∞Á∫¢Á∫øÂõæ" prop="projectRedLine">
                <el-upload ref="projectRedLineUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'projectRedLine')"
                  :file-list="projectRedLineFileList" :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'projectRedLine')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'projectRedLine')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                </el-upload>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in projectRedLineFileList" :key="file.uid"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'projectRedLine')">
                        Âà†Èô§
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="È°πÁõÆÁ∫¢Á∫øÁü¢ÈáèÊï∞ÊçÆ" prop="redLineCoordinate">
            <el-upload ref="redLineCoordinateUploadRef" multiple :action="uploadFileUrl"
              :before-upload="(file) => handleBeforeUpload(file, 'redLineCoordinate')"
              :file-list="redLineCoordinateFileList" :limit="props.limit" :accept="getFileAccept()"
              :on-error="(err, file) => handleUploadError(err, file, 'redLineCoordinate')" :on-exceed="handleExceed"
              :on-success="(res, file) => handleUploadSuccess(res, file, 'redLineCoordinate')" :show-file-list="false"
              :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
              <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
            </el-upload>
            <div class="operation-group">
              <el-button link type="primary" @click="handleDownloadTemplate('instructions')">Â°´ÂÜôËØ¥Êòé</el-button>
              <el-button link type="primary" @click="handleDownloadTemplate('polygonTemplate')">Èù¢Ê®°Êùø‰∏ãËΩΩ</el-button>
              <el-button link type="primary" @click="handleDownloadTemplate('polylineTemplate')">Á∫øÊ®°Êùø‰∏ãËΩΩ</el-button>
              <div>Ôºà‰ΩøÁî®ÂâçÔºåËØ∑Âà†Èô§Ê®°Êùø‰∏≠ÁöÑÂÆû‰æãÊï∞ÊçÆÔºâ</div>
            </div>
            <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
              tag="ul">
              <li v-for="(file, index) in redLineCoordinateFileList" :key="file.uid"
                class="el-upload-list__item ele-upload-list__item-content">
                <el-link :href="`${file.url}`" :underline="false" target="_blank">
                  <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                </el-link>
                <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                  <el-button type="danger" link @click="handleDeleteUploadFile(index, 'redLineCoordinate')">
                    Âà†Èô§
                  </el-button>
                </div>
              </li>
            </transition-group>
          </el-form-item>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="È°πÁõÆ‰∏âÁª¥Ê®°Âûã" prop="threeDModel">
                <el-upload ref="threeDModelUploadRef" multiple :action="uploadFileUrl"
                  :before-upload="(file) => handleBeforeUpload(file, 'threeDModel')" :file-list="threeDModelFileList"
                  :limit="props.limit" :accept="getFileAccept()"
                  :on-error="(err, file) => handleUploadError(err, file, 'threeDModel')" :on-exceed="handleExceed"
                  :on-success="(res, file) => handleUploadSuccess(res, file, 'threeDModel')" :show-file-list="false"
                  :headers="headers" class="upload-file-uploader" :disabled="props.compDisabled">
                  <el-button type="primary">ÁÇπÂáª‰∏ä‰º†</el-button>
                </el-upload>
                <div class="operation-group">
                  <el-button link type="primary" icon="Download"
                    @click="handleDownloadTemplate('threeD')">Ê®°ÂûãËßÑËåÉ‰∏éÊ®°Êùø‰∏ãËΩΩ</el-button>
                </div>
                <transition-group class="upload-file-list el-upload-list el-upload-list--text" name="el-fade-in-linear"
                  tag="ul">
                  <li v-for="(file, index) in threeDModelFileList" :key="file.uid"
                    class="el-upload-list__item ele-upload-list__item-content">
                    <el-link :href="`${file.url}`" :underline="false" target="_blank">
                      <span class="el-icon-document"> {{ getFileName(file.name) }} </span>
                    </el-link>
                    <div class="ele-upload-list__item-content-action" v-if="!props.compDisabled">
                      <el-button type="danger" link @click="handleDeleteUploadFile(index, 'threeDModel')">
                        Âà†Èô§
                      </el-button>
                    </div>
                  </li>
                </transition-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Ê®°ÂûãÂùêÊ†á" prop="modelCoordinate">
                <el-input v-model="form.modelCoordinate" placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãÂùêÊ†áÊ†ºÂºè‰∏∫ÔºöÁªèÂ∫¶,Á∫¨Â∫¶,È´òÂ∫¶,ÊóãËΩ¨ÊñπÂêë" />
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </div>
    <div class="add-footer">
      <el-button @click="cancel">ÂèñÊ∂à</el-button>
      <el-button type="warning" @click="resetForm">ÈáçÁΩÆ</el-button>
      <el-button type="success" v-hasPermi="['project:project:stage']" @click="temporarilyForm">ÊöÇÂ≠ò</el-button>
      <el-button :loading="buttonLoading" type="primary" @click="submitForm">Á°ÆÂÆö</el-button>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, nextTick, getCurrentInstance } from 'vue'
import { useRouter } from 'vue-router'
import { stageInfo, addInfo } from '@/api/project/normal/index';
import { delOss, listByIds } from '@/api/system/oss';
import { getUserProfile } from '@/api/system/user/index';
import { useMajorProjectStore } from '@/store/modules/majorProject'
import { useUserStore } from '@/store/modules/user'
import { propTypes } from '@/utils/propTypes';
import { globalHeaders } from '@/utils/request';
import { ElMessage } from 'element-plus'
const { proxy } = getCurrentInstance() || {}
const router = useRouter()

// ÂàùÂßãÂåñ Pinia ÂÆû‰æã
const majorProjectStore = useMajorProjectStore()
const userStore = useUserStore()

// ÂÆö‰πâÁªÑ‰ª∂Â±ûÊÄß
const props = defineProps({
  modelValue: {
    type: [String, Object, Array],
    default: () => []
  },
  // Êï∞ÈáèÈôêÂà∂
  limit: propTypes.number.def(15),
  // Â§ßÂ∞èÈôêÂà∂(MB)
  fileSize: propTypes.number.def(500),
  // Êñá‰ª∂Á±ªÂûã
  fileType: propTypes.array.def([
    'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'pdf', 'zip', 'rar',
    'dwg', 'dxf', 'jpg', 'jpeg', 'png', 'cpg', 'dbf', 'prj', 'sbn', 'sbx',
    'shp', 'shp.xml', 'shx', 'FBX', 'fbm', 'obj', 'pak'
  ]),

});

// Ë°®ÂçïÂºïÁî®
const infoFormRef = ref(null)
// ÊåâÈíÆÂä†ËΩΩÁä∂ÊÄÅ
const buttonLoading = ref(false)

// ÁªÑ‰ª∂Áä∂ÊÄÅ
const form = reactive({
  id: undefined,
  projectName: undefined,
  projectCode: undefined,
  administrativeRegion: undefined,
  scenicArea: undefined,
  applicantType: 'Âçï‰Ωç', // ÈªòËÆ§Âçï‰Ωç
  constructionUnit: undefined,
  organizationCode: undefined,
  contactPerson: undefined,
  contactPhone: undefined,
  protectionLevel: undefined,
  status: undefined,
  projectType: undefined,
  projectUsage: undefined,
  projectPurpose: undefined,
  createTime: undefined,
  updateTime: undefined,
  projectInvestment: undefined,
  planningBasis: undefined,
  constructionContent: undefined,
  otherExplanations: undefined,
  locationPlan: undefined,
  expertOpinions: undefined,
  publicMaterial: undefined,
  siteSelectionReport: undefined,
  approvalDocuments: undefined,
  projectRedLine: undefined,
  redLineCoordinate: undefined,
  threeDModel: undefined,
  modelCoordinate: undefined,
  modelPreview: undefined,
  majorFlag: false,

})

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const rules = reactive({
  projectName: [{ required: true, message: 'ËØ∑ËæìÂÖ•Âª∫ËÆæÈ°πÁõÆÂêçÁß∞', trigger: 'blur' }],
  administrativeRegion: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÊâÄÂ±ûË°åÊîøÂå∫Âàí', trigger: 'blur' }],
  applicantType: [{ required: true, message: 'ËØ∑ÈÄâÊã©Âª∫ËÆæÁ±ªÂûã', trigger: 'change' }],
  constructionUnit: [{ required: true, message: 'ËØ∑ËæìÂÖ•Âª∫ËÆæÂçï‰ΩçÂêçÁß∞', trigger: 'blur' }],
  contactPerson: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫', trigger: 'blur' }],
  contactPhone: [{
    required: true,
    message: 'ËØ∑ËæìÂÖ•ÁªèÂäû‰∫∫ËÅîÁ≥ªÊñπÂºè',
    trigger: 'blur'
  }, {
    pattern: /^1[3-9]\d{9}$/,
    message: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Á†Å',
    trigger: 'blur'
  }]
})

// ÊâÄÊúâÊñá‰ª∂ÂàóË°®
const locationPlanFileList = ref([])
const expertOpinionsFileList = ref([])
const publicMaterialFileList = ref([])
const siteSelectionReportFileList = ref([])
const approvalDocumentsFileList = ref([])
const projectRedLineFileList = ref([])
const redLineCoordinateFileList = ref([])
const threeDModelFileList = ref([])

// ‰∏ä‰º†Áõ∏ÂÖ≥ÈÖçÁΩÆ
const uploadFileUrl = import.meta.env.VITE_APP_BASE_API + '/common/upload'
const headers = reactive({
  Authorization: 'Bearer ' + userStore.token
})

// Ëé∑ÂèñÊñá‰ª∂Êé•ÂèóÁ±ªÂûã
const getFileAccept = () => {
  return props.fileType.map(type => `.${type.toLowerCase()}`).join(',')
}

// ÁîüÂëΩÂë®ÊúüÔºöÂàùÂßãÂåñÊó∂‰ªé Store ËØªÂèñÊï∞ÊçÆ
onMounted(() => {
  // Â¶ÇÊûúÊòØ‰ªéÈ¢ÑËßàÈ°µËøîÂõûÁöÑÁºñËæëÁä∂ÊÄÅ
  console.log("üöÄ ~ majorProjectStore:", majorProjectStore)
  // if (majorProjectStore.isEditDialogVisible) {
  //   Object.assign(form, majorProjectStore.formData)
  //   // ÂêåÊ≠•ÊâÄÊúâÊñá‰ª∂ÂàóË°®
  //   threeDModelFileList.value = [...majorProjectStore.threeDModelFileList]
  // }
})

// ‰∏ä‰º†ÂâçÁΩÆÊ†°È™å
const handleBeforeUpload = (file, type) => {
  // È™åËØÅÊñá‰ª∂Â§ßÂ∞è
  const isLtMaxSize = file.size / 1024 / 1024 < props.fileSize
  if (!isLtMaxSize) {
    ElMessage.error(`Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá ${props.fileSize}MB!`)
    return false
  }

  // È™åËØÅÊñá‰ª∂Á±ªÂûã
  const fileExt = file.name.split('.').pop()?.toLowerCase()
  if (!props.fileType.includes(fileExt)) {
    ElMessage.error(`‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÔºåËØ∑‰∏ä‰º†${props.fileType.join(',')}Ê†ºÂºèÁöÑÊñá‰ª∂`)
    return false
  }

  return true
}

// ‰∏ä‰º†ÈîôËØØÂ§ÑÁêÜ
const handleUploadError = (err, file, type) => {
  ElMessage.error(`‰∏ä‰º†Â§±Ë¥•: ${err.message || 'Êú™Áü•ÈîôËØØ'}`)
}

// ‰∏ä‰º†Ë∂ÖËøáÈôêÂà∂Â§ÑÁêÜ
const handleExceed = (files, fileList) => {
  ElMessage.warning(`ÊØèÊ¨°ÊúÄÂ§ö‰∏ä‰º† ${props.limit} ‰∏™Êñá‰ª∂`)
}

// ‰∏ä‰º†ÊàêÂäüÂ§ÑÁêÜ
const handleUploadSuccess = (res, file, type) => {
  if (res.code === 200) {
    // Ê†πÊçÆÁ±ªÂûãÊõ¥Êñ∞ÂØπÂ∫îÊñá‰ª∂ÂàóË°®
    const fileItem = {
      name: file.name,
      url: res.url,
      uid: file.uid,
      id: res.id // ÂÅáËÆæÊé•Âè£ËøîÂõûÊñá‰ª∂ID
    }

    switch (type) {
      case 'locationPlan':
        locationPlanFileList.value.push(fileItem)
        break
      case 'expertOpinions':
        expertOpinionsFileList.value.push(fileItem)
        break
      case 'publicMaterial':
        publicMaterialFileList.value.push(fileItem)
        break
      case 'siteSelectionReport':
        siteSelectionReportFileList.value.push(fileItem)
        break
      case 'approvalDocuments':
        approvalDocumentsFileList.value.push(fileItem)
        break
      case 'projectRedLine':
        projectRedLineFileList.value.push(fileItem)
        break
      case 'redLineCoordinate':
        redLineCoordinateFileList.value.push(fileItem)
        break
      case 'threeDModel':
        threeDModelFileList.value.push(fileItem)
        form.threeDModel = res.url // ‰øùÂ≠ò‰∏âÁª¥Ê®°ÂûãURL
        break
    }
    ElMessage.success('‰∏ä‰º†ÊàêÂäü')
  } else {
    ElMessage.error(res.msg || '‰∏ä‰º†Â§±Ë¥•')
  }
}

// Âà†Èô§‰∏ä‰º†Êñá‰ª∂
const handleDeleteUploadFile = (index, type) => {
  switch (type) {
    case 'locationPlan':
      locationPlanFileList.value.splice(index, 1)
      break
    case 'expertOpinions':
      expertOpinionsFileList.value.splice(index, 1)
      break
    case 'publicMaterial':
      publicMaterialFileList.value.splice(index, 1)
      break
    case 'siteSelectionReport':
      siteSelectionReportFileList.value.splice(index, 1)
      break
    case 'approvalDocuments':
      approvalDocumentsFileList.value.splice(index, 1)
      break
    case 'projectRedLine':
      projectRedLineFileList.value.splice(index, 1)
      break
    case 'redLineCoordinate':
      redLineCoordinateFileList.value.splice(index, 1)
      break
    case 'threeDModel':
      threeDModelFileList.value.splice(index, 1)
      if (threeDModelFileList.value.length === 0) {
        form.threeDModel = undefined
      }
      break
  }
}

// ‰∏ãËΩΩÊ®°Êùø
const handleDownloadTemplate = (type) => {
  if (type === 'instructions') {
    proxy?.$download.oss('1987829892356124674');
  } else if (type === 'polylineTemplate') {
    proxy?.$download.oss('1987829924379635713');
  } else if (type === 'polygonTemplate') {
    proxy?.$download.oss('1987829950501761026');
  } else if (type === 'threeD') {
    proxy?.$download.oss('1987830717459607554');
  }
}
/** ÂèñÊ∂àÊåâÈíÆ */
const cancel = async () => {
  router.push('/project/normal')
}
/** ÈáçÁΩÆÊåâÈíÆ */
const resetForm = () => {
  infoFormRef.value?.resetFields()
  // Ê∏ÖÁ©∫ÊâÄÊúâÊñá‰ª∂ÂàóË°®
  locationPlanFileList.value = []
  expertOpinionsFileList.value = []
  publicMaterialFileList.value = []
  siteSelectionReportFileList.value = []
  approvalDocumentsFileList.value = []
  projectRedLineFileList.value = []
  redLineCoordinateFileList.value = []
  threeDModelFileList.value = []
  // ÈáçÁΩÆË°®ÂçïÂØπË±°
  Object.keys(form).forEach(key => {
    if (key !== 'applicantType' && key !== 'majorFlag') {
      form[key] = undefined
    }
  })
}

/** ÊöÇÂ≠òÊåâÈíÆ */
const temporarilyForm = () => {
  infoFormRef.value?.validate(async (valid) => {
    if (valid) {
      buttonLoading.value = true
      try {
        // ÂáÜÂ§áÊèê‰∫§Êï∞ÊçÆÔºàÂåÖÂê´Êñá‰ª∂‰ø°ÊÅØÔºâ
        const submitData = {
          ...form,
          // ÈôÑÂä†Êñá‰ª∂ÂàóË°®
          locationPlan: locationPlanFileList.value,
          expertOpinions: expertOpinionsFileList.value,
          publicMaterial: publicMaterialFileList.value,
          siteSelectionReport: siteSelectionReportFileList.value,
          approvalDocuments: approvalDocumentsFileList.value,
          projectRedLine: projectRedLineFileList.value,
          redLineCoordinate: redLineCoordinateFileList.value,
          threeDModel: threeDModelFileList.value,
        }
        await stageInfo(submitData)
        proxy?.$modal.msgSuccess("ÊöÇÂ≠òÊàêÂäü")
        // ‰øùÂ≠òÂà∞Store
        majorProjectStore.saveDialogData({
          formData: { ...form },
          threeDModelFileList: [...threeDModelFileList.value],
          disabled: false,
          isViewMode: false
        })
      } catch (err) {
        proxy?.$modal.msgError("ÊöÇÂ≠òÂ§±Ë¥•Ôºö" + (err).message || "Êú™Áü•ÈîôËØØ")
      } finally {
        buttonLoading.value = false
      }
    }
  })
}

/** Êèê‰∫§ÊåâÈíÆ */
const submitForm = () => {
  infoFormRef.value?.validate(async (valid) => {
    if (valid) {
      buttonLoading.value = true
      try {
        // ÂáÜÂ§áÊèê‰∫§Êï∞ÊçÆÔºàÂåÖÂê´Êñá‰ª∂‰ø°ÊÅØÔºâ
        const submitData = {
          ...form,
          // ÈôÑÂä†Êñá‰ª∂ÂàóË°®
          locationPlan: locationPlanFileList.value,
          expertOpinions: expertOpinionsFileList.value,
          publicMaterial: publicMaterialFileList.value,
          siteSelectionReport: siteSelectionReportFileList.value,
          approvalDocuments: approvalDocumentsFileList.value,
          projectRedLine: projectRedLineFileList.value,
          redLineCoordinate: redLineCoordinateFileList.value,
          threeDModel: threeDModelFileList.value,
        }
        await addInfo(submitData)
        proxy?.$modal.msgSuccess("Êèê‰∫§ÊàêÂäü")
        // Êèê‰∫§ÊàêÂäüÂêéËøîÂõûÂàóË°®È°µ
        router.push('/project/normal')
      } catch (err) {
        proxy?.$modal.msgError("Êèê‰∫§Â§±Ë¥•Ôºö" + (err).message || "Êú™Áü•ÈîôËØØ")
      } finally {
        buttonLoading.value = false
      }
    }
  })
}

// ‰∏âÁª¥Ê®°ÂûãÈ¢ÑËßà
const handleModelPreview = () => {
  if (!form.threeDModel && threeDModelFileList.value.length === 0) {
    ElMessage.warning('ËØ∑ÂÖà‰∏ä‰º†‰∏âÁª¥Ê®°ÂûãÊñá‰ª∂')
    return
  }

  // ‰øùÂ≠òÈ¢ÑËßà‰ø°ÊÅØÂà∞Store
  majorProjectStore.savePreviewProjectInfo({
    id: form.id,
    threeDModel: form.threeDModel || threeDModelFileList.value[0].url,
    modelCoordinate: form.modelCoordinate,
    type: 'project'
  })
  // Ë∑≥ËΩ¨Âà∞È¢ÑËßàÈ°µÈù¢
  router.push('/preview')
}

// Êö¥Èú≤ÁªÑ‰ª∂Êé•Âè£
defineExpose({
  open: (row) => {
    if (row) {
      Object.assign(form, row)
      if (row.locationPlan) locationPlanFileList.value = [...row.locationPlan]
      if (row.expertOpinions) expertOpinionsFileList.value = [...row.expertOpinions]
      if (row.publicMaterial) publicMaterialFileList.value = [...row.publicMaterial]
      if (row.siteSelectionReport) siteSelectionReportFileList.value = [...row.siteSelectionReport]
      if (row.approvalDocuments) approvalDocumentsFileList.value = [...row.approvalDocuments]
      if (row.projectRedLine) projectRedLineFileList.value = [...row.projectRedLine]
      if (row.redLineCoordinate) redLineCoordinateFileList.value = [...row.redLineCoordinate]
      if (row.threeDModel) threeDModelFileList.value = [...row.threeDModel]
    }
  }
})
</script>

<style scoped>
.add-content-container {
  width: 100%;
  padding: 20px;
  background-color: #f6f6f6;
  box-sizing: border-box;
  position: relative;
  min-height: 100vh;
  padding-bottom: 80px;
}

.add-content {
  width: 100%;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

.add-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  background-color: #f6f6f6;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
  text-align: right;
  box-sizing: border-box;
  z-index: 10;
}

.project-basic-info,
.project-documents {
  background-color: #ffffff;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.section-title {
  font-size: 19px;
  font-weight: bold;
  color: #1f2329;
  padding-left: 5px;
  border-left: 3px solid #409eff;
}

.modelPreview {
  display: flex;
  align-items: center;

  .imgModel {
    width: 20px;
    height: 20px;
    margin-right: 5px;
    vertical-align: middle;
  }
}



.add-footer el-button+el-button {
  margin-left: 10px;
}

.upload-file-list {
  margin-top: 10px;
}

.ele-upload-list__item-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 10px;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
  margin-bottom: 5px;
}

.ele-upload-list__item-content-action {
  margin-left: 10px;
}

.operation-group {
  margin-top: 10px;
  margin-bottom: 15px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

.operation-group div {
  color: #666;
  font-size: 18px;
}
</style>
<style>
body {
  overflow: auto;
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}

body::-webkit-scrollbar {
  display: none !important;
  /* Chrome/Safari */
  width: 0 !important;
  height: 0 !important;
}

* {
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}

*::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
  height: 0 !important;
}
</style>